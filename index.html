<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><filter id='glow' x='-50%25' y='-50%25' width='200%25' height='200%25'><feGaussianBlur stdDeviation='4' result='blur'/><feMerge><feMergeNode in='blur'/><feMergeNode in='SourceGraphic'/></feMerge></filter></defs><rect width='100' height='100' rx='20' fill='%230c0a1e'/><text x='50' y='70' font-family='Arial, sans-serif' font-size='60' font-weight='bold' fill='%230ff' stroke='%23fff' stroke-width='1' text-anchor='middle' filter='url(%23glow)'>ID</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>ìžŽì½”ëŒ€ì‰¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3/dist/js.cookie.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
      :root {
        --glow-color: #0ff;
        --secondary-glow-color: #f0f;
        --danger-glow-color: #f00;
        --warn-glow-color: #ff0;
        --bg-color: #0c0a1e;
      }
      body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: var(--bg-color);
        overflow: hidden;
        touch-action: none;
      }
      @keyframes glow {
        0%, 100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--glow-color), 0 0 20px var(--glow-color); }
        50% { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px var(--glow-color), 0 0 40px var(--glow-color); }
      }
      .glowing-text {
        animation: glow 1.5s ease-in-out infinite;
      }
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
       @keyframes overlay-fade-in {
        from { opacity: 0; backdrop-filter: blur(0px); }
        to { opacity: 1; backdrop-filter: blur(5px); }
      }
      .fade-in { animation: fade-in 0.5s ease-out forwards; }
      .overlay-fade-in { animation: overlay-fade-in 0.3s ease-out forwards; }
      
      /* Player Animations */
      @keyframes run-cycle { 0%, 100% { transform: translateY(0) rotate(-2deg); } 50% { transform: translateY(-6px) rotate(2deg); } }
      .player-running { animation: run-cycle 0.4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
      .player-jumping { transform: rotate(-10deg); }
      .player-falling { transform: rotate(10deg); }
      @keyframes giant-stomp { 0%, 100% { transform: translateY(0) scale(1.5); } 50% { transform: translateY(-10px) scale(1.5); } }
      .player-giant { animation: giant-stomp 0.5s ease-in-out infinite; }
      @keyframes player-invincible-blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
      }
      .player-invincible {
        animation: player-invincible-blink 0.2s linear infinite;
      }
      
      /* Boss Animations */
      @keyframes boss-idle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
      @keyframes boss-enter { from { transform: translateX(200%); } to { transform: translateX(0); } }
      
      /* Gacha Animations */
      @keyframes box-shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
      @keyframes reveal-glow { from { opacity: 0; box-shadow: 0 0 0px 0px #fff; } to { opacity: 1; box-shadow: 0 0 100px 50px #fff; } }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

      /* Visual Effects */
      @keyframes hit-flash-anim { 0% { opacity: 0.5; } 100% { opacity: 0; } }
      .hit-flash-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: red; pointer-events: none; opacity: 0; animation: hit-flash-anim 0.2s ease-out; z-index: 100; }
      @keyframes fever-glow {
        0%, 100% {
          background: radial-gradient(circle, rgba(255, 235, 59, 0.2) 0%, rgba(255, 235, 59, 0) 70%);
          box-shadow: 0 0 20px 10px rgba(255, 235, 59, 0);
        }
        50% {
          background: radial-gradient(circle, rgba(255, 235, 59, 0.4) 0%, rgba(255, 235, 59, 0) 70%);
          box-shadow: 0 0 40px 20px rgba(255, 235, 59, 0.4);
        }
      }
      .fever-active-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; animation: fever-glow 1s ease-in-out infinite; z-index: 10; }
      .shield-effect { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120%; height: 120%; border: 4px solid #0ff; border-radius: 50%; box-shadow: 0 0 15px #0ff; opacity: 0.7; animation: glow 1.5s ease-in-out infinite alternate; }
      .shadow-form-effect { box-shadow: inset 0 0 20px 10px rgba(72, 61, 139, 0.8); filter: brightness(0.8) drop-shadow(0 0 10px #483d8b); }
      .obstacle-highlight { box-shadow: 0 0 20px 10px #ffdead; border: 2px solid #ffdead; border-radius: inherit; }
      
      /* UI Elements */
      .ui-button {
        background-color: rgba(0, 255, 255, 0.2);
        border: 2px solid var(--glow-color);
        border-radius: 12px;
        padding: 12px 24px;
        color: white;
        font-weight: bold;
        text-shadow: 0 0 5px var(--glow-color);
        transition: all 0.2s ease;
        -webkit-tap-highlight-color: transparent;
      }
      .ui-button:hover, .ui-button:active {
        background-color: rgba(0, 255, 255, 0.4);
        box-shadow: 0 0 15px var(--glow-color);
        transform: scale(1.05);
      }
       .ui-button:disabled {
        background-color: rgba(128, 128, 128, 0.2);
        border-color: #888;
        color: #888;
        text-shadow: none;
        box-shadow: none;
        cursor: not-allowed;
        transform: scale(1);
      }
      .ui-button.danger {
        background-color: rgba(255, 0, 0, 0.2);
        border-color: var(--danger-glow-color);
        text-shadow: 0 0 5px var(--danger-glow-color);
      }
      .ui-button.danger:hover, .ui-button.danger:active {
        background-color: rgba(255, 0, 0, 0.4);
        box-shadow: 0 0 15px var(--danger-glow-color);
      }
      .selection-card {
        border: 2px solid #555;
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .selection-card.selected {
        border-color: var(--glow-color);
        box-shadow: 0 0 15px var(--glow-color);
        transform: scale(1.05);
      }
      .progress-bar-container {
        background-color: rgba(0,0,0,0.5);
        border-radius: 9999px;
        padding: 2px;
        border: 1px solid #555;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        border-radius: 9999px;
        transition: width 0.3s ease;
      }
      .health-bar { background: linear-gradient(90deg, #ff4d4d, #a3ff4d); }
      .fever-bar { background: linear-gradient(90deg, #ff9800, #ffeb3b); box-shadow: 0 0 10px #ffeb3b; }
      .boss-health-bar { background: linear-gradient(90deg, #f0f, #9400D3); }

      .control-button {
        position: absolute;
        bottom: 5vh;
        width: 16vh;
        height: 16vh;
        max-width: 100px;
        max-height: 100px;
        background-color: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        transition: all 0.1s ease-out;
      }
      .control-button:active {
        background-color: rgba(0, 255, 255, 0.4);
        border-color: var(--glow-color);
        transform: scale(1.1);
      }
       .skill-button {
         position: absolute;
         bottom: 24vh;
         right: 4vw;
         width: 14vh;
         height: 14vh;
         max-width: 90px;
         max-height: 90px;
         background-color: rgba(138, 43, 226, 0.3);
         border: 2px solid #9370DB;
         box-shadow: 0 0 10px #9370DB;
       }
       .skill-button.ready {
         animation: pulse-glow 1.5s infinite;
       }
       @keyframes pulse-glow {
         0%, 100% { box-shadow: 0 0 10px #9370DB; }
         50% { box-shadow: 0 0 25px #9370DB, 0 0 10px #fff; }
       }
       .skill-button .cooldown-overlay {
         position: absolute;
         inset: 0;
         background: rgba(0,0,0,0.7);
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 2em;
         font-weight: bold;
         color: white;
       }
      
      .nav-button {
        background: none;
        border: none;
        color: #888;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: bold;
        transition: color 0.2s ease, text-shadow 0.2s ease;
      }
      .nav-button:hover, .nav-button.active {
        color: var(--glow-color);
        text-shadow: 0 0 8px var(--glow-color);
      }
      .main-overlay {
        position: absolute;
        inset: 0;
        z-index: 50;
        background: rgba(12, 10, 30, 0.8);
        backdrop-filter: blur(5px);
        display: flex;
        flex-direction: column;
      }
       .jump-indicator-container {
        position: absolute;
        bottom: 22vh;
        left: 4vw;
        max-width: 100px;
        width: 16vh;
        display: flex;
        justify-content: center;
        gap: 12px;
      }
      .jump-indicator {
        width: 20px;
        height: 20px;
        background: var(--glow-color);
        border-radius: 50%;
        box-shadow: 0 0 8px var(--glow-color);
        transition: all 0.2s ease;
      }
      .jump-indicator.used {
        background: #555;
        box-shadow: none;
      }
      .settings-button {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
        color: #888;
        transition: all 0.2s ease;
      }
      .settings-button:hover {
        color: white;
        transform: scale(1.1) rotate(45deg);
      }
      .text-input {
        background-color: rgba(0,0,0,0.5);
        border: 2px solid #555;
        border-radius: 8px;
        padding: 8px 12px;
        color: white;
        transition: border-color 0.2s ease;
      }
      .text-input:focus {
        outline: none;
        border-color: var(--glow-color);
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react": "https://esm.sh/react@18.2.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module">
        import React from 'react';
        import ReactDOM from 'react-dom/client';

        // --- START OF COMBINED GAME CODE ---

        // --- START OF MERGED types.ts ---
        const IVector2D = {}; const CharacterSkill = {}; const PetSkill = {}; const TreasureType = {}; const MissionType = {}; const RewardType = {}; const PartnerBonusType = {}; const GameObjectType = {}; const GameStatus = {};
        // --- END OF MERGED types.ts ---

        // --- START OF MERGED constants.tsx ---

        const WORLD_WIDTH = 1280; const WORLD_HEIGHT = 720; const GROUND_HEIGHT = 60; const GRAVITY = 3000; const PLAYER_X_POSITION = 150;
        const PLAYER_JUMP_FORCE = 1100; const PLAYER_RUN_SIZE = { x: 50, y: 70 }; const PLAYER_SLIDE_SIZE = { x: 70, y: 40 };
        const INITIAL_MAX_HEALTH = 100; const HEALTH_DECAY_RATE = 1; const OBSTACLE_DAMAGE = 25; 
        const INITIAL_GAME_SPEED = 350; const GAME_SPEED_INCREASE_RATE = 2; const MAX_GAME_SPEED = 750;
        const FEVER_GAUGE_MAX = 100; const FEVER_GAUGE_PER_JELLY = 5; const FEVER_DURATION = 8; const FEVER_OBSTACLE_SCORE = 100;
        
        const GIANT_POTION_DURATION = 8; const BLAST_JELLY_DURATION = 1.5; const BLAST_JELLY_SPEED_MULTIPLIER = 2.5; const MAGNET_ITEM_DURATION = 10; const MAGNET_RADIUS = 250;
        const BOSS_MAX_HEALTH = 2500;
        const MAX_PLAYER_LEVEL = 100;
        const XP_FOR_LEVEL = (level) => level >= MAX_PLAYER_LEVEL ? Infinity : Math.floor(100 * Math.pow(1.5, level - 1));

        const SvgIconWrapper = ({ children, color, filterId, className }) => (
            React.createElement('svg', { viewBox: "0 0 100 100", xmlns: "http://www.w3.org/2000/svg", className: className || "w-full h-full", style: { filter: `url(#${filterId})` } },
                React.createElement('defs', null, React.createElement('filter', { id: filterId, x:"-50%", y:"-50%", width:"200%", height:"200%" },
                    React.createElement('feDropShadow', { dx: "0", dy: "0", stdDeviation: "5", floodColor: color }),
                    React.createElement('feDropShadow', { dx: "0", dy: "0", stdDeviation: "8", floodColor: color })
                )),
                children
            )
        );

        const RAW_CHARACTERS = {
            'char1': { id: 'char1', name: 'ë„¤ì˜¨ ìŠ¤íŠ¸ë¼ì´ì»¤', description: 'ê¸°ë³¸ì— ì¶©ì‹¤í•œ ë°¸ëŸ°ìŠ¤í˜• ëŸ°ë„ˆìž…ë‹ˆë‹¤.', skill: 'none', baseStat: 100, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#0ff", filterId: "char1-glow", className: className }, React.createElement('rect', { x: "25", y: "30", width: "50", height: "70", rx: "10", fill: "#0ff", stroke: "#fff", strokeWidth: "5" }), React.createElement('circle', { cx: "50", cy: "30", r: "20", fill: "#0ff", stroke: "#fff", strokeWidth: "5" })) },
            'char2': { id: 'char2', name: 'ë§ˆì  íƒ€ íŒ¬í…€', description: 'ë” ë†’ì€ ì²´ë ¥ì„ ê°€ì§€ê³  ì˜¤ëž˜ ë²„íŒë‹ˆë‹¤.', skill: 'extra_health', baseStat: 130, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#f0f", filterId: "char2-glow", className: className }, React.createElement('polygon', { points: "50,10 90,90 10,90", fill: "#f0f", stroke: "#fff", strokeWidth: "5" })) },
            'char3': { id: 'char3', name: 'ë³¼í…ìŠ¤', description: 'ê²Œìž„ ì‹œìž‘ ì‹œ ìžì„ íš¨ê³¼ë¥¼ ê°€ì§€ê³  ì‹œìž‘í•©ë‹ˆë‹¤.', skill: 'start_magnet', baseStat: 90, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#9400D3", filterId: "char3-glow", className: className }, React.createElement('path', { d: "M50 10 C 90 10, 90 90, 50 90 S 10 90, 10 10 C 10 10, 50 10, 50 10 Z", transform: "rotate(45 50 50)", fill: "none", stroke: "#9400D3", strokeWidth: "6" }), React.createElement('circle', { cx: "50", cy: "50", r: "10", fill: "#fff" })) },
            'char4': { id: 'char4', name: 'í¬ë¡œë…¸', description: 'ì²´ë ¥ì´ 50% ì´í•˜ê°€ ë˜ë©´ ê²Œìž„ ì†ë„ê°€ ëŠë ¤ì§‘ë‹ˆë‹¤.', skill: 'time_slow', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#00fa9a", filterId: "char4-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "40", fill: "none", stroke: "#00fa9a", strokeWidth: "6", strokeDasharray: "10 5" }), React.createElement('path', { d: "M50 20 V50 H70", fill: "none", stroke: "#fff", strokeWidth: "6" })) },
            'char5': { id: 'char5', name: 'ë¸”ë ˆì´ì¦ˆ', description: 'ê²Œìž„ ì†ë„ê°€ ë” ë¹ ë¥´ì§€ë§Œ, ì ìˆ˜ ë³´ë„ˆìŠ¤ë¥¼ ì–»ìŠµë‹ˆë‹¤.', skill: 'high_speed', baseStat: 80, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ff4500", filterId: "char5-glow", className: className }, React.createElement('path', { d: "M50 10 L60 40 L90 45 L65 65 L70 95 L50 80 L30 95 L35 65 L10 45 L40 40 Z", fill: "#ff4500", stroke: "#fff", strokeWidth: "4" })) },
            'char6': { id: 'char6', name: 'í´ë¡œë²„', description: 'ê²Œìž„ì— ì•„ì´í…œì´ ë” ìžì£¼ ë“±ìž¥í•©ë‹ˆë‹¤.', skill: 'item_boost', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#32cd32", filterId: "char6-glow", className: className }, React.createElement('path', { d: "M50 25 C 30 5, 30 40, 50 50 C 70 40, 70 5, 50 25 Z", fill: "#32cd32" }), React.createElement('path', { d: "M75 50 C 95 30, 60 30, 50 50 C 60 70, 95 70, 75 50 Z", fill: "#32cd32" }), React.createElement('path', { d: "M50 75 C 30 95, 30 60, 50 50 C 70 60, 70 95, 50 75 Z", fill: "#32cd32" }), React.createElement('path', { d: "M25 50 C 5 30, 40 30, 50 50 C 40 70, 5 70, 25 50 Z", fill: "#32cd32" })) },
            'char7': { id: 'char7', name: 'ì‹œë„ˆì§€', description: 'ìž¥ì°©í•œ íŽ«ì˜ ëŠ¥ë ¥ì´ 25% í–¥ìƒë©ë‹ˆë‹¤.', skill: 'pet_boost', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#fafad2", filterId: "char7-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "30", fill: "none", stroke: "#fafad2", strokeWidth: "6" }), React.createElement('circle', { cx: "50", cy: "50", r: "15", fill: "#fafad2" })) },
            'char8': { id: 'char8', name: 'í”¼ë‹‰ìŠ¤', description: 'ì²´ë ¥ì´ 25% ì´í•˜ì¼ ë•Œ, ë‹¨ í•œ ë²ˆ ê°•ë ¥í•œ ë³´í˜¸ë§‰ì„ ìƒì„±í•©ë‹ˆë‹¤.', skill: 'emergency_shield', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ff8c00", filterId: "char8-glow", className: className }, React.createElement('path', { d: "M20 80 Q 50 20, 80 80 Q 50 50, 20 80 Z", fill: "#ff8c00" }), React.createElement('path', { d: "M30 70 Q 50 30, 70 70 Q 50 55, 30 70 Z", fill: "#ff4500", stroke:"#fff", strokeWidth:"2" })) },
            'char9': { id: 'char9', name: 'ì—ì½”', description: 'ëª¨ë“  ì•„ì´í…œì˜ íš¨ê³¼(íšŒë³µëŸ‰, ì§€ì†ì‹œê°„)ê°€ 2ë°° ì´ìƒ ì¦ê°€í•©ë‹ˆë‹¤.', skill: 'item_double_effect', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#00ced1", filterId: "char9-glow", className: className }, React.createElement('path', { d: "M50 20 A 30 30 0 0 1 50 80 A 30 30 0 0 1 50 20 M50 35 A 15 15 0 0 1 50 65 A 15 15 0 0 1 50 35", fill: "none", stroke: "#00ced1", strokeWidth: "6" }), React.createElement('circle', { cx: "50", cy: "50", r: "5", fill: "#fff" })) },
            'char10': { id: 'char10', name: 'ë¦¬í”„íŠ¸', description: 'ìŠ¬ë¼ì´ë“œ ì¤‘ì—ëŠ” ìž¥ì• ë¬¼ì— í”¼í•´ë¥¼ ìž…ì§€ ì•ŠìŠµë‹ˆë‹¤.', skill: 'slide_invincible', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#7b68ee", filterId: "char10-glow", className: className }, React.createElement('path', { d: "M20 80 L50 20 L80 80 H20 Z", fill: "#7b68ee", stroke: "#fff", strokeWidth: "4", transform: "skewX(-10)" }), React.createElement('path', { d: "M30 80 L50 40 L70 80", fill: "none", stroke: "#fff", strokeWidth: "3", opacity: "0.7" })) },
            'char11': { id: 'char11', name: 'ê¸€ë¦¬ì¹˜', description: 'ê°€ë”ì”© ì•žìœ¼ë¡œ ìˆœê°„ì´ë™í•˜ì—¬ ìž¥ì• ë¬¼ì„ í†µê³¼í•©ë‹ˆë‹¤.', skill: 'random_teleport', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ff00ff", filterId: "char11-glow", className: className }, React.createElement('text', { x: "50", y: "70", fontFamily: "monospace", fontSize: "60", textAnchor: "middle", fill: "#ff00ff", stroke:"#fff", strokeWidth: "2" }, "ERR")) },
            'char12': { id: 'char12', name: 'ë±…ì»¤', description: '10ì´ˆë§ˆë‹¤ í˜„ìž¬ ì ìˆ˜ì˜ 1.2%ë¥¼ ë³´ë„ˆìŠ¤ë¡œ ì–»ìŠµë‹ˆë‹¤.', skill: 'interest_score', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#00ff7f", filterId: "char12-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "35", fill: "#00ff7f" }), React.createElement('text', { x: "50", y: "68", fontSize: "45", textAnchor: "middle", fill: "black", fontWeight: "bold" }, "$")) },
            'char14': { id: 'char14', name: 'ë¦¬ë“¬', description: 'ì—°ì†ìœ¼ë¡œ 5íšŒ ì í”„ ì‹œ ì¶”ê°€ ì ìˆ˜ë¥¼ ì–»ìŠµë‹ˆë‹¤.', skill: 'rhythm_bonus', baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ff1493", filterId: "char14-glow", className: className }, React.createElement('path', { d: "M20 70 Q 35 40, 50 70 T 80 70", stroke: "#ff1493", strokeWidth: "6", fill: "none" }), React.createElement('path', { d: "M20 50 Q 35 20, 50 50 T 80 50", stroke: "#ff1493", strokeWidth: "6", fill: "none" })) },
            'char15': { id: 'char15', name: 'ê²Œì´ì €', description: 'ì•¡í‹°ë¸Œ ìŠ¤í‚¬: ì „ë°©ìœ¼ë¡œ íŒŒê´´ì ì¸ ë ˆì´ì €ë¥¼ ë°œì‚¬í•©ë‹ˆë‹¤.', skill: 'laser_beam', cooldown: 7, baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ff6347", filterId: "char15-glow", className: className }, React.createElement('path', { d: "M50 20 L80 50 L50 80 L20 50 Z", fill: "#ff6347" }), React.createElement('circle', { cx: "50", cy: "50", r: "15", fill: "white" }), React.createElement('circle', { cx: "50", cy: "50", r: "8", fill: "red" })) },
            'char16': { id: 'char16', name: 'ë ˆì´ë¸', description: 'ì•¡í‹°ë¸Œ ìŠ¤í‚¬: ì²´ë ¥ì„ ì†Œëª¨í•˜ì—¬ ê·¸ë¦¼ìž í˜•íƒœê°€ ë©ë‹ˆë‹¤. ê·¸ë¦¼ìž í˜•íƒœì—ì„œëŠ” ë¬´ì ì´ë©° ì ¤ë¦¬ ì ìˆ˜ê°€ 2ë°°ê°€ ë©ë‹ˆë‹¤.', skill: 'shadow_pact', cooldown: 20, baseStat: 100, unlockCost: 3000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#483d8b", filterId: "char16-glow", className: className }, React.createElement('path', { d: "M50 10 C 30 30, 20 70, 50 90 C 80 70, 70 30, 50 10 Z", fill: "#483d8b" }), React.createElement('path', { d: "M50 20 C 40 35, 35 60, 50 80 C 65 60, 60 35, 50 20 Z", fill: "#000" })) },
        };
        const CHARACTERS = Object.fromEntries(Object.entries(RAW_CHARACTERS).map(([id, char]) => [id, {...char, description: `${char.description} (ê¸°ë³¸ ì²´ë ¥: ${char.baseStat})` }]));

        const PETS = {
            'pet1': { id: 'pet1', name: 'íë¸Œ', description: 'ì¼ì • ì‹œê°„ë§ˆë‹¤ ì²´ë ¥ í¬ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.', skill: 'health_potion', baseStat: 20, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#fff", filterId: "pet1-glow", className: className }, React.createElement('rect', { x: "20", y: "20", width: "60", height: "60", rx: "10", fill: "#fff", stroke: "#000", strokeWidth: "5", transform: "rotate(45 50 50)" })) },
            'pet2': { id: 'pet2', name: 'ìœ™í‚¤', description: 'ì ¤ë¦¬ íšë“ ì‹œ ì¶”ê°€ ì ìˆ˜ë¥¼ ì¤ë‹ˆë‹¤.', skill: 'score_bonus', baseStat: 1, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ff0", filterId: "pet2-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "30", fill: "#ff0" }), React.createElement('path', { d: "M 35,40 Q 50,60 65,40", stroke: "black", strokeWidth: "5", fill: "none" })) },
            'pet4': { id: 'pet4', name: 'ìŠ¤íŒŒí¬', description: 'ì ¤ë¦¬ íšë“ ì‹œ í”¼ë²„ ê²Œì´ì§€ë¥¼ ì¶”ê°€ë¡œ ì±„ì›ë‹ˆë‹¤.', skill: 'fever_boost', baseStat: 1, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ffa500", filterId: "pet4-glow", className: className }, React.createElement('path', { d: "M50 10 L40 45 H60 L50 90 L60 55 H40 Z", fill: "#ffa500", stroke: "#fff", strokeWidth: "4" })) },
            'pet5': { id: 'pet5', name: 'ì œíŠ¸', description: 'ì²´ë ¥ì´ 0ì´ ë˜ë©´, í•œ ë²ˆ ë¶€í™œí•©ë‹ˆë‹¤ (ì²´ë ¥ 25%).', skill: 'revive', baseStat: 1, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#b0c4de", filterId: "pet5-glow", className: className }, React.createElement('path', { d: "M50 20 L70 40 L60 45 L80 65 L50 90 L20 65 L40 45 L30 40 Z", fill: "#b0c4de", stroke: "#fff", strokeWidth: "4" })) },
            'pet6': { id: 'pet6', name: 'ë§ˆì´ë”ìŠ¤', description: 'ê²Œìž„ ì¢…ë£Œ ì‹œ íšë“í•˜ëŠ” ì ¤ë¦¬ê°€ ì¦ê°€í•©ë‹ˆë‹¤.', skill: 'currency_boost', baseStat: 5, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ffd700", filterId: "pet6-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "35", fill: "#ffd700", stroke: "#fff", strokeWidth: "4" }), React.createElement('text', { x: "50", y: "65", fontSize: "40", textAnchor: "middle", fill: "black", fontWeight: "bold" }, "J")) },
            'pet7': { id: 'pet7', name: 'ìˆ˜í˜¸ë ¹', description: '5% í™•ë¥ ë¡œ ìž¥ì• ë¬¼ í”¼í•´ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤.', skill: 'damage_negation', baseStat: 5, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#add8e6", filterId: "pet7-glow", className: className }, React.createElement('path', { d: "M50 20 C 30 40, 30 70, 50 80 C 70 70, 70 40, 50 20 Z", fill: "#add8e6", opacity:"0.7" }), React.createElement('circle', { cx: "50", cy: "50", r: "5", fill: "#fff" })) },
            'pet8': { id: 'pet8', name: 'ë“€ë¼', description: 'ëª¨ë“  ì•„ì´í…œì˜ ì§€ì† ì‹œê°„ì´ 25% ì¦ê°€í•©ë‹ˆë‹¤.', skill: 'item_duration_boost', baseStat: 0.25, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#cd853f", filterId: "pet8-glow", className: className }, React.createElement('path', { d: "M30 20 H70 L60 50 L70 80 H30 L40 50 Z", fill: "#cd853f", stroke: "#fff", strokeWidth: "4" })) },
            'pet9': { id: 'pet9', name: 'ì˜µì €ë²„', description: 'ê²Œìž„ ì¢…ë£Œ í›„, ë¯¸ì…˜ ì§„í–‰ë„ê°€ 10% ì¶”ê°€ë©ë‹ˆë‹¤.', skill: 'mission_progress_boost', baseStat: 0.1, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#4682b4", filterId: "pet9-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "35", fill: "#4682b4" }), React.createElement('circle', { cx: "50", cy: "50", r: "20", fill: "#fff" }), React.createElement('circle', { cx: "50", cy: "50", r: "10", fill: "#000" })) },
            'pet10': { id: 'pet10', name: 'ê³¨ë””', description: 'ì¼ì • ì‹œê°„ë§ˆë‹¤ ë³´ë„ˆìŠ¤ ì ¤ë¦¬(í° ì ¤ë¦¬)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.', skill: 'generate_bonus_jelly', baseStat: 25, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#daa520", filterId: "pet10-glow", className: className }, React.createElement('rect', { x: "25", y: "35", width: "50", height: "30", rx: "5", fill: "#daa520", stroke: "#fff", strokeWidth: "4" }), React.createElement('circle', { cx: "50", cy: "50", r: "10", fill: "gold", stroke: "black", strokeWidth: "2" })) },
            'pet11': { id: 'pet11', name: 'íŽ˜ì´ì„œ', description: 'ê²Œìž„ ì†ë„ ì¦ê°€ìœ¨ì´ 15% ê°ì†Œí•©ë‹ˆë‹¤.', skill: 'pace_keeper', baseStat: 0.15, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#87ceeb", filterId: "pet11-glow", className: className }, React.createElement('path', { d: "M20 50 L40 30 L60 70 L80 50", stroke: "#87ceeb", strokeWidth: "6", fill: "none" })) },
            'pet12': { id: 'pet12', name: 'ë¯¸ë¯¹', description: 'ì•„ì´í…œ íšë“ ì‹œ 20% í™•ë¥ ë¡œ ë³µì œí•©ë‹ˆë‹¤.', skill: 'copy_item', baseStat: 0.2, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ba55d3", filterId: "pet12-glow", className: className }, React.createElement('circle', { cx: "35", cy: "50", r: "20", fill: "#ba55d3" }), React.createElement('circle', { cx: "65", cy: "50", r: "20", fill: "#ba55d3", opacity: "0.7" })) },
            'pet13': { id: 'pet13', name: 'ë¸”ë¼ìŠ¤í† ì´ë“œ', description: 'ì ¤ë¦¬ 50ê°œë¥¼ ëª¨ìœ¼ë©´ ìž‘ì€ í­ë°œì„ ì¼ìœ¼í‚µë‹ˆë‹¤.', skill: 'jelly_blast', baseStat: 50, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#dc143c", filterId: "pet13-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "30", fill: "#dc143c" }), React.createElement('path', { d: "M50 20 L55 45 L80 50 L55 55 L50 80 L45 55 L20 50 L45 45 Z", fill: "yellow" })) },
            'pet14': { id: 'pet14', name: 'ìŠ¤íŒŒí‚¤', description: 'í”¼ë²„ ê²Œì´ì§€ 30%ë¥¼ ê°€ì§€ê³  ì‹œìž‘í•©ë‹ˆë‹¤.', skill: 'fever_start_boost', baseStat: 30, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#f0e68c", filterId: "pet14-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "25", fill: "#f0e68c" }), React.createElement('path', { d: "M50 25 V75 M25 50 H75", stroke: "#fff", strokeWidth: "6" })) },
            'pet15': { id: 'pet15', name: 'íŽ„ìŠ¤', description: 'ì•¡í‹°ë¸Œ ìŠ¤í‚¬: í™”ë©´ì˜ ëª¨ë“  ìž¥ì• ë¬¼ì„ íŒŒê´´í•©ë‹ˆë‹¤.', skill: 'emp_blast', cooldown: 15, baseStat: 1, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#00BFFF", filterId: "pet15-glow", className: className }, React.createElement('path', { d: "M50 20 A 30 30 0 0 1 50 80 A 30 30 0 0 1 50 20 M50 35 A 15 15 0 0 1 50 65 A 15 15 0 0 1 50 35", fill: "none", stroke: "#00BFFF", strokeWidth: "8" }), React.createElement('circle', { cx: "50", cy: "50", r: "5", fill: "white" })) },
            'pet16': { id: 'pet16', name: 'ì˜¤ë¼í´', description: 'ì¼ì • ì‹œê°„ë§ˆë‹¤ ë‹¤ìŒì— ë‚˜íƒ€ë‚  ìž¥ì• ë¬¼ì„ ë¯¸ë¦¬ í‘œì‹œí•´ì¤ë‹ˆë‹¤.', skill: 'foresight', baseStat: 15, unlockCost: 1000, Icon: ({ className }) => React.createElement(SvgIconWrapper, { color: "#ffdead", filterId: "pet16-glow", className: className }, React.createElement('circle', { cx: "50", cy: "50", r: "30", fill: "none", stroke: "#ffdead", strokeWidth: "6" }), React.createElement('circle', { cx: "50", cy: "30", r: "8", fill: "#fff" })) },
        };
        
        const PARTNER_BONUSES = {
            'char1_pet1': { name: 'ë‹¨ë‹¨í•œ ìœ ëŒ€', description: 'ìµœëŒ€ ì²´ë ¥ +15', type: 'max_health_bonus', value: 15 }, 'char2_pet2': { name: 'í™©ê¸ˆ ë“€ì˜¤', description: 'ì ¤ë¦¬ íšë“ ì ìˆ˜ +10%', type: 'jelly_score_bonus', value: 0.1 }, 'char5_pet4': { name: 'íƒ€ì˜¤ë¥´ëŠ” ì—´ì •', description: 'í”¼ë²„ ì§€ì† ì‹œê°„ +15%', type: 'fever_duration_bonus', value: 0.15 }, 'char8_pet5': { name: 'ë¶ˆì‚¬ì¡°ì˜ ì˜ì§€', description: 'ë¶€í™œ ì‹œ ì²´ë ¥ 50%ë¡œ ë¶€í™œ', type: 'revive_health_bonus', value: 0.5 }, 'char6_pet6': { name: 'í–‰ìš´ì˜ ë¶€ìž', description: 'ê²Œìž„ ì¢…ë£Œ ì ¤ë¦¬ ë³´ë„ˆìŠ¤ +10%', type: 'currency_bonus_final', value: 0.1 }, 'char3_pet7': { name: 'ìžê¸°ìž¥ ê°•í™”', description: 'ìžì„ ì•„ì´í…œ ì§€ì† ì‹œê°„ +30%', type: 'magnet_duration_bonus', value: 0.3 }, 'char4_pet8': { name: 'ì‹œê°„ì˜ ì§€ë°°ìž', description: 'ìŠ¬ë¡œìš° íš¨ê³¼ ì§€ì† ì‹œê°„ +20%', type: 'slow_duration_bonus', value: 0.2 }, 'char1_pet2': { name: 'ëŸ¬ë„ˆìŠ¤ í•˜ì´', description: 'ê¸°ë³¸ ì ¤ë¦¬ ì ìˆ˜ +5', type: 'base_jelly_score_bonus', value: 5 }, 'char2_pet1': { name: 'ê°•í™” í”„ë ˆìž„', description: 'ìž¥ì• ë¬¼ ì¶©ëŒ ë°ë¯¸ì§€ 15% ê°ì†Œ', type: 'damage_reduction', value: 0.15 }, 'char7_pet8': { name: 'ì•„ì´í…œ ë§ˆìŠ¤í„°', description: 'ëª¨ë“  ì•„ì´í…œ ì§€ì† ì‹œê°„ +10%', type: 'all_item_duration_bonus', value: 0.1 }, 'char15_pet15': { name: 'ì‹œìŠ¤í…œ ë¶•ê´´', description: 'ì•¡í‹°ë¸Œ ìŠ¤í‚¬ ì¿¨íƒ€ìž„ -10%', type: 'active_skill_cooldown_reduction', value: 0.1 },
            'char16_pet16': { name: 'ê·¸ë¦¼ìž ì˜ˆì–¸', description: 'ê·¸ë¦¼ìž í˜•íƒœ ì§€ì†ì‹œê°„ +1ì´ˆ', type: 'shadow_pact_duration_bonus', value: 1 },
        };

        const TREASURES = {
            'tr1': { id: 'tr1', name: 'ë¹›ë‚˜ëŠ” ê¹ƒí„¸', description: 'ì í”„ ë†’ì´ +5%', type: 'jump_boost', value: 0.05 }, 'tr2': { id: 'tr2', name: 'ê²¬ê³ í•œ ì‹¬ìž¥', description: 'ìµœëŒ€ ì²´ë ¥ +10', type: 'health_bonus', value: 10 }, 'tr3': { id: 'tr3', name: 'ì§ˆì£¼ì˜ ë¶€ì¸ ', description: 'ê¸°ë³¸ ì†ë„ +5%', type: 'speed_boost', value: 0.05 }, 'tr4': { id: 'tr4', name: 'í™©ê¸ˆ ë‚˜ì¹¨ë°˜', description: 'íšë“ ì ìˆ˜ +5%', type: 'score_bonus', value: 0.05 }, 'tr5': { id: 'tr5', name: 'ì—´ì •ì˜ ë¶ˆê½ƒ', description: 'í”¼ë²„ ì‹œê°„ +10%', type: 'fever_duration', value: 0.1 }, 'tr6': { id: 'tr6', name: 'í™©ê¸ˆ ì ¤ë¦¬', description: 'ì ¤ë¦¬ ì ìˆ˜ +10%', type: 'base_jelly_score_percentage_bonus', value: 0.1 }, 'tr7': { id: 'tr7', name: 'ìžë ¥ì˜ ëŒ', description: 'ìžì„ ì‹œê°„ +20%', type: 'magnet_duration', value: 0.2 }, 'tr8': { id: 'tr8', name: 'ê±°ì¸ì˜ ë¬¼ì•½', description: 'ê±°ì¸í™” ì‹œê°„ +20%', type: 'giant_duration', value: 0.2 }, 'tr9': { id: 'tr9', name: 'ì ˆì•½ì˜ ë™ì „', description: 'ë¹„ìš© -5%', type: 'cost_reduction', value: 0.05 }, 'tr10': { id: 'tr10', name: 'í–‰ìš´ì˜ ë„¤ìžŽí´ë¡œë²„', description: 'ìƒìž í–‰ìš´ ì¦ê°€', type: 'luck_boost', value: 0.1 },
        };

        const MISSIONS = [
            { id: 'm1', description: 'ì ¤ë¦¬ 500ê°œ ìˆ˜ì§‘', type: 'collect_jellies', target: 500, reward: { currency: 100, gachaChests: 0 } }, { id: 'm2', description: '1,000m ë‹¬ë¦¬ê¸°', type: 'run_distance', target: 1000, reward: { currency: 100, gachaChests: 0 } }, { id: 'm3', description: 'ìž¥ì• ë¬¼ 20ê°œ íŒŒê´´', type: 'destroy_obstacles', target: 20, reward: { currency: 150, gachaChests: 0 } }, { id: 'm4', description: 'ì í”„ 100ë²ˆ í•˜ê¸°', type: 'jump_count', target: 100, reward: { currency: 100, gachaChests: 0 } }, { id: 'm5', description: 'í”¼ë²„ íƒ€ìž„ 5ë²ˆ ë°œë™', type: 'fever_count', target: 5, reward: { currency: 2700, gachaChests: 0 } }, { id: 'm6', description: 'í•œ ê²Œìž„ì—ì„œ 10,000ì  ë‹¬ì„±', type: 'single_run_score', target: 10000, reward: { currency: 250, gachaChests: 0 } }, { id: 'm7', description: 'ì ¤ë¦¬ 2,500ê°œ ìˆ˜ì§‘', type: 'collect_jellies', target: 2500, reward: { currency: 300, gachaChests: 0 } }, { id: 'm8', description: '5,000m ë‹¬ë¦¬ê¸°', type: 'run_distance', target: 5000, reward: { currency: 300, gachaChests: 0 } }, { id: 'm9', description: 'ì•„ì´í…œ 25ê°œ ì‚¬ìš©', type: 'use_items', target: 25, reward: { currency: 200, gachaChests: 0 } }, { id: 'm10', description: 'ì´ 50,000ì  ëˆ„ì ', type: 'total_score', target: 50000, reward: { currency: 3000, gachaChests: 0 } },
        ];
        
        const ENHANCEMENTS = {
            'health': { name: 'ê¸°ë³¸ ì²´ë ¥ ê°•í™”', description: (lvl) => `ìµœëŒ€ ì²´ë ¥ +${lvl * 5} ì˜êµ¬ ì¦ê°€`, maxLevel: 20, baseValue: 5 }, 'jelly_score': { name: 'ì ¤ë¦¬ ì ìˆ˜ ê°•í™”', description: (lvl) => `ëª¨ë“  ì ¤ë¦¬ ì ìˆ˜ +${lvl * 2}% ì˜êµ¬ ì¦ê°€`, maxLevel: 25, baseValue: 0.02 }, 'fever_duration': { name: 'í”¼ë²„ ì‹œê°„ ê°•í™”', description: (lvl) => `í”¼ë²„ ì‹œê°„ +${(lvl * 0.1).toFixed(1)}ì´ˆ ì˜êµ¬ ì¦ê°€`, maxLevel: 20, baseValue: 0.1 }, 'currency_gain': { name: 'ì ¤ë¦¬ íšë“ëŸ‰ ê°•í™”', description: (lvl) => `ê²Œìž„ ì¢…ë£Œ ì ¤ë¦¬ +${lvl * 2}% ì˜êµ¬ ì¦ê°€`, maxLevel: 25, baseValue: 0.02 }
        };
        const ENHANCEMENT_COST = (level, reduction = 0) => Math.floor(500 * Math.pow(1.2, level) * (1 - reduction));

        const LEVEL_UP_COST = (level, reduction = 0) => Math.floor((100 * Math.pow(1.25, level)) * (1 - reduction));
        const TREASURE_LEVEL_UP_COST = (level, reduction = 0) => Math.floor((200 * Math.pow(1.3, level)) * (1 - reduction));
        const GACHA_COST = 5000;

        const getCharacterStat = (char, level) => {
            return char.baseStat + (level - 1) * 15;
        };

        const getPetStat = (pet, level, isSynergy) => {
            let baseStat = 0;
            switch(pet.skill) {
                case 'health_potion': baseStat = Math.max(5, pet.baseStat - (level - 1)); break;
                case 'score_bonus': baseStat = pet.baseStat + (level - 1); break;
                case 'fever_boost': baseStat = pet.baseStat + (level - 1) * 0.5; break;
                case 'currency_boost': baseStat = pet.baseStat + (level - 1) * 2; break;
                case 'damage_negation': baseStat = pet.baseStat + (level - 1) * 0.5; break;
                case 'generate_bonus_jelly': baseStat = Math.max(10, pet.baseStat - (level - 1) * 1.5); break;
                case 'jelly_blast': baseStat = Math.max(20, pet.baseStat - (level - 1) * 3); break;
                case 'foresight': baseStat = Math.max(5, pet.baseStat - (level - 1)); break;
                case 'revive': baseStat = 0.25 + (level - 1) * 0.01; break;
                case 'item_duration_boost': baseStat = 0.25 + (level - 1) * 0.015; break;
                case 'mission_progress_boost': baseStat = 0.1 + (level - 1) * 0.01; break;
                case 'pace_keeper': baseStat = 0.15 + (level - 1) * 0.005; break;
                case 'copy_item': baseStat = 0.2 + (level - 1) * 0.01; break;
                case 'fever_start_boost': baseStat = 30 + (level - 1) * 2; break;
                case 'emp_blast': baseStat = pet.baseStat; break;
                default: baseStat = pet.baseStat; break;
            }
            if (isSynergy) {
                 let boost = 1.25;
                 if (['health_potion', 'generate_bonus_jelly', 'jelly_blast', 'foresight'].includes(pet.skill)) return baseStat * (2 - boost);
                 return baseStat * boost;
            }
            return baseStat;
        };
        
        // Game Object Icons
        const ObstacleLowIcon = () => React.createElement('div', { className: "w-full h-full bg-red-500 border-2 border-white rounded-md", style: { boxShadow: '0 0 10px #f00' } });
        const ObstacleHighIcon = () => React.createElement('div', { className: "w-full h-full bg-red-500 border-2 border-white rounded-md", style: { boxShadow: '0 0 10px #f00' } });
        const ObstacleSpikesIcon = () => React.createElement('div', { className: "w-full h-full bg-red-800 flex justify-around items-end p-1", style: { boxShadow: '0 0 10px #f00' } }, Array(5).fill(0).map((_, i) => React.createElement('div', { key: i, style: { width: '15%', height: '100%', background: 'white', clipPath: 'polygon(50% 0, 0 100%, 100% 100%)' } })));
        const ObstacleFallingIcon = () => React.createElement('div', { className: "w-full h-full bg-red-700 rounded-full border-2 border-white flex items-center justify-center", style: { boxShadow: '0 0 15px #f00', animation: 'spin 1s linear infinite' } }, 'â–¼');
        const ObstacleSlideIcon = () => React.createElement('div', { className: "w-full h-full bg-red-600 border-2 border-white rounded-md", style: { boxShadow: '0 0 10px #f00' } });
        const JellyIcon = () => React.createElement('div', { className: "w-full h-full rounded-full bg-yellow-300", style: { boxShadow: '0 0 8px #ff0' } });
        const BigJellyIcon = () => React.createElement('div', { className: "w-full h-full rounded-full bg-yellow-300 relative flex items-center justify-center", style: { boxShadow: '0 0 15px #ff0' } }, React.createElement('div', { className: "w-1/2 h-1/2 rounded-full bg-white/50" }));
        const RainbowBearJellyIcon = () => React.createElement('div', { className: "w-full h-full rounded-2xl flex items-center justify-center text-5xl", style: { background: 'linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet)', animation: 'glow 1s ease-in-out infinite alternate', boxShadow: '0 0 20px #fff' } }, 'ðŸ»');
        const GoldenBearJellyIcon = () => React.createElement('div', { className: "w-full h-full rounded-2xl flex items-center justify-center text-5xl bg-yellow-400", style: { boxShadow: '0 0 20px #ffd700' } }, 'ðŸ»');
        const PinkBearJellyIcon = () => React.createElement('div', { className: "w-full h-full rounded-2xl flex items-center justify-center text-5xl bg-pink-400", style: { boxShadow: '0 0 20px #ff69b4' } }, 'ðŸ»');
        const PartyBearJellyIcon = () => React.createElement('div', { className: "w-full h-full rounded-2xl flex items-center justify-center text-5xl", style: { background: 'repeating-conic-gradient(red 0% 10%, yellow 10% 20%, blue 20% 30%)', animation: 'spin 2s linear infinite', boxShadow: '0 0 20px #fff' } }, 'ðŸ»');
        
        const HealthPotionIcon = () => React.createElement(SvgIconWrapper, { color: "#0f0", filterId: "health-glow" }, React.createElement('path', { d: "M50,15 L50,85 M15,50 L85,50", stroke: "#0f0", strokeWidth: "12", strokeLinecap: "round" }));
        const GiantPotionIcon = () => React.createElement(SvgIconWrapper, { color: "#f0f", filterId: "giant-glow" }, React.createElement('path', { d: "M25,70 L50,30 L75,70 M25,50 L50,10 L75,50", fill: "none", stroke: "#f0f", strokeWidth: "12", strokeLinecap: "round" }));
        const BlastJellyIcon = () => React.createElement(SvgIconWrapper, { color: "#ff8c00", filterId: "blast-glow" }, React.createElement('circle', { cx: "50", cy: "50", r: "30", fill: "#ff8c00" }), React.createElement('path', { d: "M50,20 L55,45 L80,50 L55,55 L50,80 L45,55 L20,50 L45,45 Z", fill: "yellow" }));
        const MagnetItemIcon = () => React.createElement(SvgIconWrapper, { color: "#00f", filterId: "magnet-glow" }, React.createElement('path', { d: "M25 80 V 50 A 25 25 0 0 1 75 50 V 80", stroke: "#00f", strokeWidth: "15", fill: "none", strokeLinecap: "round" }), React.createElement('rect', { x: "15", y: "80", width: "20", height: "10", fill: "red" }), React.createElement('rect', { x: "65", y: "80", width: "20", height: "10", fill: "white" }));
        
        const BossIcon = () => React.createElement('div', {className: 'w-full h-full'}, React.createElement(SvgIconWrapper, { color: "#f0f", filterId: "boss-glow" }, 
           React.createElement('path', { d: "M 50,10 L 90,40 L 80,90 L 20,90 L 10,40 Z", fill: "#333", stroke: "#f0f", strokeWidth: "4" }),
           React.createElement('circle', { cx: "50", cy: "45", r: "15", fill: "red", stroke: "white", strokeWidth: "2" }),
           React.createElement('path', { d: "M 30,70 L 40,60 L 60,60 L 70,70 Z", fill: "#555" })
        ));
        const EnergyCoreIcon = () => React.createElement('div', { className: "w-full h-full rounded-full bg-cyan-300", style: { boxShadow: '0 0 15px #0ff', animation: 'glow 1.5s ease-in-out infinite' } });
        const BossProjectileIcon = () => React.createElement('div', { className: "w-full h-full rounded-full bg-red-500", style: { boxShadow: '0 0 10px #f00' } });
        const GazerLaserIcon = () => React.createElement('div', { className: "w-full h-full rounded-lg bg-gradient-to-r from-red-500 via-orange-300 to-red-500", style: { boxShadow: '0 0 15px #ff6347' } });
        const SettingsIcon = () => React.createElement('svg', { viewBox: "0 0 100 100", fill: "currentColor", xmlns: "http://www.w3.org/2000/svg" },
            React.createElement('path', { d: "M89.1,54.6l-8.6-3.1c-0.4-1.6-1-3.2-1.7-4.7l4.5-7.9c1.2-2.1,0.7-4.8-1.1-6.4l-6.2-6.2 c-1.6-1.8-4.3-2.3-6.4-1.1l-7.9,4.5c-1.5-0.7-3.1-1.3-4.7-1.7l-3.1-8.6C53.3,7,51.1,5.6,48.7,5.6h-8.8c-2.4,0-4.5,1.4-5.4,3.5 l-3.1,8.6c-1.6,0.4-3.2,1-4.7,1.7l-7.9-4.5c-2.1-1.2-4.8-0.7-6.4,1.1l-6.2,6.2c-1.8,1.6-2.3,4.3-1.1,6.4l4.5,7.9 c-0.7,1.5-1.3,3.1-1.7,4.7l-8.6,3.1c-2.1,0.8-3.5,2.9-3.5,5.4v8.8c0,2.4,1.4,4.5,3.5,5.4l8.6,3.1c0.4,1.6,1,3.2,1.7,4.7l-4.5,7.9 c-1.2,2.1-0.7,4.8,1.1,6.4l6.2,6.2c1.6,1.8,4.3,2.3,6.4,1.1l7.9-4.5c1.5,0.7,3.1,1.3,4.7,1.7l3.1,8.6c0.8,2.1,2.9,3.5,5.4,3.5h8.8 c2.4,0,4.5-1.4,5.4-3.5l3.1-8.6c1.6-0.4,3.2-1,4.7-1.7l7.9,4.5c2.1,1.2,4.8,0.7,6.4-1.1l6.2-6.2c1.8-1.6,2.3,4.3,1.1-6.4 l-4.5-7.9c0.7-1.5,1.3-3.1,1.7-4.7l8.6-3.1c2.1-0.8,3.5-2.9,3.5-5.4v-8.8C92.6,57.5,91.2,55.4,89.1,54.6z M50,65.8 c-8.7,0-15.8-7.1-15.8-15.8S41.3,34.2,50,34.2S65.8,41.3,65.8,50S58.7,65.8,50,65.8z" })
        );

        // --- END OF MERGED constants.tsx ---

        // --- START OF MERGED App.tsx ---

        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const useGameLoop = (callback, isRunning) => {
            const animationFrameId = useRef();
            const lastTime = useRef(performance.now());
            const loop = useCallback((time) => { const deltaTime = (time - lastTime.current) / 1000; lastTime.current = time; callback(deltaTime); animationFrameId.current = requestAnimationFrame(loop); }, [callback]);
            useEffect(() => { if (isRunning) { lastTime.current = performance.now(); animationFrameId.current = requestAnimationFrame(loop); } return () => { if (animationFrameId.current) cancelAnimationFrame(animationFrameId.current); }; }, [isRunning, loop]);
        };

        const App = () => {
            const [playerData, setPlayerData] = useState(null);
            const [selectedCharId, setSelectedCharId] = useState('char1');
            const [selectedPetId, setSelectedPetId] = useState('pet1');
            const [activeOverlay, setActiveOverlay] = useState(null);
            const [hitFlash, setHitFlash] = useState(false);
            const [scale, setScale] = useState(1);
            const [gachaResult, setGachaResult] = useState(null);
            const [gachaState, setGachaState] = useState('idle');
            const [teamDetailView, setTeamDetailView] = useState(null);
            const [nicknameInput, setNicknameInput] = useState('');
            const [levelUpInfo, setLevelUpInfo] = useState(null);
            
            const [gameState, setGameState] = useState({ status: 'menu', score: 0, distance: 0, gameSpeed: INITIAL_GAME_SPEED, isFeverTime: false, feverGauge: 0, feverTimeLeft: 0, isPaused: false, activeSkillCooldown: 0, worldLevel: 1 });
            const [bossState, setBossState] = useState({ isActive: false, health: 0, maxHealth: BOSS_MAX_HEALTH, attackTimer: 0, pattern: 'idle', pos: {x:0,y:0} });

            const playerStateRef = useRef(null);
            const gameObjectsRef = useRef([]);
            const backgroundXRef = useRef(0);
            const nextSpawnDistanceRef = useRef(0);
            const petSkillTimerRef = useRef({});
            const inGameStatsRef = useRef({ jellies: 0, distance: 0, obstaclesDestroyed: 0, jumps: 0, fevers: 0, itemsUsed: 0, currentRunScore: 0, bossKills: 0 });
            const reviveUsedRef = useRef(false);
            const [, forceUpdate] = useState({});
            const [currentView, setCurrentView] = useState('main');

            const activePartnerBonus = useMemo(() => { if (!playerData) return null; const comboKey = `${selectedCharId}_${selectedPetId}`; return PARTNER_BONUSES[comboKey] || null; }, [selectedCharId, selectedPetId, playerData]);
            
            const playerLevelBonuses = useMemo(() => {
                if (!playerData) return { health: 0, score: 0, currency: 0 };
                const level = playerData.level;
                return {
                    health: level * 2,
                    score: level * 0.001,
                    currency: level * 0.001
                };
            }, [playerData?.level]);
            
            useEffect(() => {
                const handleResize = () => { const newScale = Math.min(window.innerWidth / WORLD_WIDTH, window.innerHeight / WORLD_HEIGHT); setScale(newScale); };
                window.addEventListener('resize', handleResize);
                handleResize();
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const COOKIE_NAME = 'ipkoDashDataV4_player_level';
                try {
                    const savedData = Cookies.get(COOKIE_NAME);
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        const initialEnhancements = { health: 0, jelly_score: 0, fever_duration: 0, currency_gain: 0 };
                        
                        parsedData.enhancements = { ...initialEnhancements, ...parsedData.enhancements };
                        if (!parsedData.treasures) parsedData.treasures = [];
                        if (!parsedData.equippedTreasures) parsedData.equippedTreasures = [];
                        if (!parsedData.memoryFragments) parsedData.memoryFragments = 0;
                        if (!parsedData.treasureLevels) parsedData.treasureLevels = {};
                        if (!parsedData.nickname) parsedData.nickname = 'Runner';
                        if (parsedData.level === undefined) parsedData.level = 1;
                        if (parsedData.xp === undefined) parsedData.xp = 0;
                        
                        Object.keys(parsedData.characters).forEach(charId => {
                           delete parsedData.characters[charId].awakened;
                           delete parsedData.characters[charId].transcendence;
                        });
                        Object.keys(parsedData.pets).forEach(petId => {
                           delete parsedData.pets[petId].awakened;
                        });
                        
                        setPlayerData(parsedData);
                        setNicknameInput(parsedData.nickname);
                    } else {
                        const initialData = { level: 1, xp: 0, nickname: 'Runner', characters: { 'char1': { level: 1 } }, pets: { 'pet1': { level: 1 } }, currency: 5000, highScore: 0, missions: {}, treasures: [], equippedTreasures: [], memoryFragments: 0, enhancements: { health: 0, jelly_score: 0, fever_duration: 0, currency_gain: 0 }, treasureLevels: {} };
                        setPlayerData(initialData);
                        setNicknameInput(initialData.nickname);
                    }
                } catch (error) { console.error("Failed to load player data:", error); }
            }, []);

            useEffect(() => { if (playerData) { try { Cookies.set('ipkoDashDataV4_player_level', JSON.stringify(playerData), { expires: 365 }); } catch (error) { console.error("Failed to save player data:", error); } } }, [playerData]);
            
            const getTreasureValue = useCallback((type) => {
                if (!playerData?.equippedTreasures) return 0;
                return playerData.equippedTreasures
                    .map(id => TREASURES[id])
                    .filter(t => t && t.type === type)
                    .reduce((sum, t) => {
                        const level = playerData.treasureLevels?.[t.id] || 0;
                        const multiplier = 1 + level * 0.15; // 15% bonus per level
                        return sum + t.value * multiplier;
                    }, 0);
            }, [playerData?.equippedTreasures, playerData?.treasureLevels]);
            
            const updateMissions = useCallback((stats) => {
                const petData = playerData.pets[selectedPetId] || { level: 1 };
                const pet = PETS[selectedPetId];
                const isObserverEquipped = pet.skill === 'mission_progress_boost';
                const isSynergy = selectedCharId === 'char7';
                
                const observerBonus = isObserverEquipped ? getPetStat(pet, petData.level, isSynergy) : 0;

                setPlayerData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    let changed = false;
                    MISSIONS.forEach(mission => {
                        const missionProgress = newData.missions[mission.id] || { progress: 0, completed: false };
                        if (missionProgress.completed) return;
                        let progressToAdd = 0;
                        switch(mission.type) {
                            case 'collect_jellies': progressToAdd = stats.jellies; break; case 'run_distance': progressToAdd = stats.distance; break; case 'destroy_obstacles': progressToAdd = stats.obstaclesDestroyed; break; case 'jump_count': progressToAdd = stats.jumps; break; case 'fever_count': progressToAdd = stats.fevers; break; case 'use_items': progressToAdd = stats.itemsUsed; break; case 'single_run_score': if(stats.currentRunScore > missionProgress.progress) { missionProgress.progress = stats.currentRunScore; } break; case 'total_score': progressToAdd = stats.currentRunScore; break; case 'boss_kills': progressToAdd = stats.bossKills; break;
                        }
                        
                        if (isObserverEquipped && progressToAdd > 0) {
                           progressToAdd *= (1 + observerBonus);
                        }

                        if(progressToAdd > 0) missionProgress.progress += progressToAdd;
                        if (missionProgress.progress >= mission.target) { missionProgress.completed = true; }
                        newData.missions[mission.id] = missionProgress;
                        changed = true;
                    });
                    return changed ? newData : prev;
                });
            }, [selectedPetId, selectedCharId, playerData]);

            const finalizeRun = useCallback(() => {
                updateMissions(inGameStatsRef.current);
                setPlayerData(prev => {
                    if (!prev) return null;
                    const newHighScore = Math.max(prev.highScore, gameState.score);
                    
                    const petData = prev.pets[selectedPetId] || { level: 1 };
                    const pet = PETS[selectedPetId];
                    const isSynergy = selectedCharId === 'char7';

                    let petBonus = 1;
                    if(pet.skill === 'currency_boost') {
                        petBonus = 1 + getPetStat(pet, petData.level, isSynergy) / 100;
                    }
                    if(activePartnerBonus?.type === 'currency_bonus_final') petBonus += activePartnerBonus.value;
                    const enhancementBonus = 1 + (prev.enhancements.currency_gain || 0) * ENHANCEMENTS.currency_gain.baseValue;
                    const levelBonus = 1 + playerLevelBonuses.currency;
                    const earnedCurrency = Math.floor(inGameStatsRef.current.jellies * 5 * petBonus * enhancementBonus * levelBonus);
                    return { ...prev, highScore: newHighScore, currency: Math.floor(prev.currency + earnedCurrency) };
                });
            }, [gameState.score, selectedCharId, selectedPetId, activePartnerBonus, updateMissions, playerLevelBonuses]);

            const startGame = () => {
                const character = CHARACTERS[selectedCharId];
                const pet = PETS[selectedPetId];
                const charData = playerData.characters[selectedCharId] || { level: 1 };
                const petData = playerData.pets[selectedPetId] || { level: 1 };
                
                const enhancementBonus = (playerData.enhancements.health || 0) * ENHANCEMENTS.health.baseValue;
                let maxHealth = getCharacterStat(character, charData.level) + getTreasureValue('health_bonus') + enhancementBonus + playerLevelBonuses.health;
                if (activePartnerBonus?.type === 'max_health_bonus') maxHealth += activePartnerBonus.value;
                let baseSpeed = INITIAL_GAME_SPEED * (1 + getTreasureValue('speed_boost'));
                if (character.skill === 'high_speed') baseSpeed *= 1.2;
                if (pet.skill === 'pace_keeper') baseSpeed *= 1.05;

                playerStateRef.current = { pos: { x: PLAYER_X_POSITION, y: WORLD_HEIGHT - GROUND_HEIGHT - PLAYER_RUN_SIZE.y }, size: PLAYER_RUN_SIZE, vy: 0, health: maxHealth, maxHealth: maxHealth, isJumping: false, jumpCount: 0, rhythmJumpCombo: 0, isSliding: false, isGiant: false, isBlasting: false, hasMagnet: false, isShadowForm: false, activeEffects: {}, skillTimers: { teleport: 5, interest: 10 }, jellyBlastCounter: 0, invincibilityTimer: 0, shield: 0, emergencyShieldUsed: false };
                if (character.skill === 'start_magnet') { playerStateRef.current.activeEffects['magnet'] = 5 + Math.floor(charData.level / 5); }
                
                const isSynergy = selectedCharId === 'char7';
                let initialFever = 0;
                if (pet.skill === 'fever_start_boost') { 
                    initialFever = FEVER_GAUGE_MAX * (getPetStat(pet, petData.level, isSynergy) / 100);
                }
                gameObjectsRef.current = [];
                nextSpawnDistanceRef.current = 0;
                backgroundXRef.current = 0;
                petSkillTimerRef.current = { health_potion: 0, generate_bonus_jelly: 0, foresight: 0 };
                inGameStatsRef.current = { jellies: 0, distance: 0, obstaclesDestroyed: 0, jumps: 0, fevers: 0, itemsUsed: 0, currentRunScore: 0, bossKills: 0 };
                reviveUsedRef.current = false;
                setGameState({ status: 'playing', score: 0, distance: 0, gameSpeed: baseSpeed, isFeverTime: false, feverGauge: initialFever, feverTimeLeft: 0, isPaused: false, activeSkillCooldown: 0, worldLevel: 1 });
                setBossState({ isActive: false, health: 0, maxHealth: BOSS_MAX_HEALTH, attackTimer: 0, pattern: 'idle', pos: {x:0,y:0} });
            };

            const triggerGameOver = () => {
                if (gameState.status === 'gameOver') return;
                finalizeRun();
                setGameState(prev => ({ ...prev, status: 'gameOver' }));
            };

            const togglePause = () => { 
                if (gameState.status !== 'playing') return;
                const newPausedState = !gameState.isPaused;
                 if (newPausedState) {
                    setActiveOverlay('paused'); 
                } else {
                    setActiveOverlay(null);
                }
                setGameState(prev => ({ ...prev, isPaused: newPausedState })); 
            };
            
            const createBlast = (center, radius) => {
                const affected = [];
                gameObjectsRef.current.forEach(obj => {
                    if (obj.type.startsWith('obstacle') || obj.type === 'jelly' || obj.type === 'big_jelly' || obj.type.endsWith('_item') || obj.type.endsWith('_potion') || obj.type === 'blast_jelly') {
                        const objCenter = { x: obj.pos.x + obj.size.x / 2, y: obj.pos.y + obj.size.y / 2 };
                        const dist = Math.sqrt(Math.pow(objCenter.x - center.x, 2) + Math.pow(objCenter.y - center.y, 2));
                        if (dist < radius) { affected.push(obj.id); }
                    }
                });
                if (affected.length > 0) { 
                    const destroyedObstacles = gameObjectsRef.current.filter(obj => affected.includes(obj.id) && obj.type.startsWith('obstacle')).length;
                    inGameStatsRef.current.obstaclesDestroyed += destroyedObstacles; 
                    gameObjectsRef.current = gameObjectsRef.current.filter(obj => !affected.includes(obj.id)); 
                }
            };

            const spawnGameObject = useCallback(() => {
                const newObjects = [];
                const basePos = { x: WORLD_WIDTH + 100, y: 0 };
                const jellySize = {x: 20, y: 20};
                const jellyY = WORLD_HEIGHT - GROUND_HEIGHT - 60;
                const bearY = WORLD_HEIGHT - GROUND_HEIGHT - 150;
                const bearSize = { x: 60, y: 80 };

                const specialJellyRoll = Math.random();
                if (specialJellyRoll < 0.005) {
                    newObjects.push({ id: Math.random(), type: 'golden_bear_jelly', pos: { x: basePos.x, y: bearY }, size: bearSize, Icon: GoldenBearJellyIcon });
                } else if (specialJellyRoll < 0.01) {
                    newObjects.push({ id: Math.random(), type: 'pink_bear_jelly', pos: { x: basePos.x, y: bearY }, size: bearSize, Icon: PinkBearJellyIcon });
                } else if (specialJellyRoll < 0.015) {
                    newObjects.push({ id: Math.random(), type: 'party_bear_jelly', pos: { x: basePos.x, y: bearY }, size: bearSize, Icon: PartyBearJellyIcon });
                } else if (specialJellyRoll < 0.02) {
                    newObjects.push({ id: Math.random(), type: 'rainbow_bear_jelly', pos: { x: basePos.x, y: bearY }, size: bearSize, Icon: RainbowBearJellyIcon });
                } else {
                    const pattern = Math.random();
                    const character = CHARACTERS[selectedCharId];
                    let itemRoll = Math.random();
                    if (character.skill === 'item_boost') itemRoll *= 0.6;

                    if (itemRoll < 0.1) {
                        const itemTypeRoll = Math.random(); let itemType, ItemIcon;
                        if(itemTypeRoll < 0.33) { itemType = 'blast_jelly'; ItemIcon = BlastJellyIcon; } 
                        else if(itemTypeRoll < 0.66) { itemType = 'magnet_item'; ItemIcon = MagnetItemIcon; }
                        else { itemType = 'giant_potion'; ItemIcon = GiantPotionIcon; }
                        newObjects.push({ id: Math.random(), type: itemType, pos: { x: basePos.x, y: WORLD_HEIGHT - GROUND_HEIGHT - 120 }, size: {x: 40, y: 40}, Icon: ItemIcon });
                    } else {
                        if (pattern < 0.1) { const size = { x: 60, y: 50 }; newObjects.push({ id: Math.random(), type: 'obstacle_low', pos: { x: basePos.x, y: WORLD_HEIGHT - GROUND_HEIGHT - size.y }, size, Icon: ObstacleLowIcon }); }
                        else if (pattern < 0.2) { const size = { x: 80, y: 120 }; newObjects.push({ id: Math.random(), type: 'obstacle_high', pos: { x: basePos.x, y: WORLD_HEIGHT - GROUND_HEIGHT - size.y }, size, Icon: ObstacleHighIcon }); }
                        else if (pattern < 0.25) { const size = { x: 120, y: 40 }; newObjects.push({ id: Math.random(), type: 'obstacle_spikes', pos: { x: basePos.x, y: WORLD_HEIGHT - GROUND_HEIGHT - size.y }, size, Icon: ObstacleSpikesIcon }); }
                        else if (pattern < 0.3) { const size = { x: 100, y: 60 }; newObjects.push({ id: Math.random(), type: 'obstacle_slide', pos: { x: basePos.x, y: WORLD_HEIGHT - GROUND_HEIGHT - 160 }, size, Icon: ObstacleSlideIcon }); }
                        else if (pattern < 0.35) { const size = { x: 50, y: 50 }; newObjects.push({ id: Math.random(), type: 'obstacle_falling', pos: { x: basePos.x + Math.random() * 100, y: -size.y }, size, Icon: ObstacleFallingIcon, vy: 0 }); }
                        else if (pattern < 0.8) { for (let i = 0; i < 8; i++) { const yOffset = Math.sin(i * 0.8) * 40; newObjects.push({ id: Math.random(), type: 'jelly', pos: { x: basePos.x + i * 50, y: jellyY + yOffset - 40 }, size: jellySize, Icon: JellyIcon }); } }
                        else if (pattern < 0.95) { const size = { x: 60, y: 50 }; newObjects.push({ id: Math.random(), type: 'obstacle_low', pos: { x: basePos.x, y: WORLD_HEIGHT - GROUND_HEIGHT - size.y }, size, Icon: ObstacleLowIcon }); for (let i = 0; i < 3; i++) newObjects.push({ id: Math.random(), type: 'jelly', pos: { x: basePos.x - 10 + i * 40, y: WORLD_HEIGHT - GROUND_HEIGHT - 120 }, size: jellySize, Icon: JellyIcon }); }
                        else { for (let i = 0; i < 3; i++) { const size = { x: 40, y: 40 }; newObjects.push({ id: Math.random(), type: 'obstacle_low', pos: { x: basePos.x + i * 150, y: WORLD_HEIGHT - GROUND_HEIGHT - size.y }, size, Icon: ObstacleLowIcon }); } }
                    }
                }
                gameObjectsRef.current.push(...newObjects); nextSpawnDistanceRef.current = gameState.distance + Math.random() * 200 + 200;
            }, [gameState.distance, selectedCharId, playerData]);

            const gameLoop = useCallback((deltaTime) => {
                if (gameState.isPaused || gameState.status === 'gameOver') return; const player = playerStateRef.current; if (!player) return; 
                const character = CHARACTERS[selectedCharId]; 
                const pet = PETS[selectedPetId]; 
                const charData = playerData.characters[selectedCharId] || { level: 1 };
                const petData = playerData.pets[selectedPetId] || { level: 1 };
                const isSynergy = selectedCharId === 'char7';
                
                if (player.invincibilityTimer > 0) {
                    player.invincibilityTimer -= deltaTime;
                }
                
                setGameState(prev => ({...prev, activeSkillCooldown: Math.max(0, prev.activeSkillCooldown - deltaTime) }));

                let speedMultiplier = 1; let speedIncreaseRate = GAME_SPEED_INCREASE_RATE;
                if (player.isBlasting) speedMultiplier = BLAST_JELLY_SPEED_MULTIPLIER;
                else if (player.isShadowForm) speedMultiplier = 1.2;
                else if (character.skill === 'time_slow' && player.health < player.maxHealth * 0.5) { let slowDurBonus = activePartnerBonus?.type === 'slow_duration_bonus' ? activePartnerBonus.value : 0; speedMultiplier = 0.75 * (1 - slowDurBonus); }
                if (pet.skill === 'pace_keeper') { speedIncreaseRate *= (1 - getPetStat(pet, petData.level, isSynergy)); }

                let newGameSpeed, actualSpeed, newDistance, newScore, newFeverGauge;
                
                newGameSpeed = Math.min(MAX_GAME_SPEED, gameState.gameSpeed + speedIncreaseRate * deltaTime);
                actualSpeed = newGameSpeed * speedMultiplier; 
                backgroundXRef.current = (backgroundXRef.current - actualSpeed * deltaTime * 0.5) % WORLD_WIDTH;
                newDistance = gameState.distance + actualSpeed * deltaTime; 
                inGameStatsRef.current.distance += actualSpeed * deltaTime / 100; newScore = gameState.score; newFeverGauge = gameState.feverGauge;
                
                Object.keys(player.activeEffects).forEach(effect => { player.activeEffects[effect] -= deltaTime; if (player.activeEffects[effect] <= 0) { delete player.activeEffects[effect]; if(effect === 'giant') player.isGiant = false; if(effect === 'blast') player.isBlasting = false; if(effect === 'magnet') player.hasMagnet = false; if(effect === 'shadow_pact') player.isShadowForm = false;} });
                player.vy -= GRAVITY * deltaTime; player.pos.y -= player.vy * deltaTime;
                if (player.pos.y > WORLD_HEIGHT - GROUND_HEIGHT - player.size.y) { player.pos.y = WORLD_HEIGHT - GROUND_HEIGHT - player.size.y; player.vy = 0; if (player.isJumping) { player.isJumping = false; player.jumpCount = 0; if (player.rhythmJumpCombo > 1) { newScore += player.rhythmJumpCombo * 100; } player.rhythmJumpCombo = 0; } }

                player.health -= HEALTH_DECAY_RATE * deltaTime;
                if (character.skill === 'emergency_shield' && !player.emergencyShieldUsed && player.health < player.maxHealth * 0.25) {
                    player.emergencyShieldUsed = true;
                    player.shield = 1 + Math.floor((charData.level - 1) / 5);
                    player.invincibilityTimer = 1.0;
                }
                
                if (player.health <= 0) {
                    if (pet.skill === 'revive' && !reviveUsedRef.current) {
                        reviveUsedRef.current = true;
                        let reviveHealth = getPetStat(pet, petData.level, isSynergy);
                        if(activePartnerBonus?.type === 'revive_health_bonus') reviveHealth = activePartnerBonus.value;
                        player.health = player.maxHealth * reviveHealth;
                        player.invincibilityTimer = 2.0;
                    } else {
                        triggerGameOver();
                        return;
                    }
                }

                let newFeverTimeLeft = gameState.feverTimeLeft; if (gameState.isFeverTime) { newFeverTimeLeft -= deltaTime; if (newFeverTimeLeft <= 0) { setGameState(prev => ({...prev, isFeverTime: false})); newFeverTimeLeft = 0; } }

                if (character.skill === 'random_teleport') { player.skillTimers.teleport -= deltaTime; if (player.skillTimers.teleport <= 0) { player.skillTimers.teleport = Math.max(1.5, 4 - (charData.level - 1) * 0.1) + Math.random() * 4; if (Math.random() < 0.35 + (charData.level - 1) * 0.015) player.pos.x += 150; } }
                if (character.skill === 'interest_score') { player.skillTimers.interest -= deltaTime; if (player.skillTimers.interest <= 0) { player.skillTimers.interest = 10; newScore += Math.floor(gameState.score * (0.012 + (charData.level - 1) * 0.00025)); } }
                
                const petStat = getPetStat(pet, petData.level, isSynergy);
                if (pet.skill === 'health_potion' || pet.skill === 'generate_bonus_jelly') { 
                    petSkillTimerRef.current[pet.skill] = (petSkillTimerRef.current[pet.skill] || 0) + deltaTime; 
                    if (petSkillTimerRef.current[pet.skill] >= petStat) { 
                        petSkillTimerRef.current[pet.skill] = 0; let type, Icon, size = {x: 30, y: 30};
                        if (pet.skill === 'health_potion') { type = 'health_potion_item'; Icon = HealthPotionIcon; } 
                        else { type = 'big_jelly'; Icon = BigJellyIcon; }
                        gameObjectsRef.current.push({ id: Math.random(), type, pos: { x: WORLD_WIDTH + 50, y: WORLD_HEIGHT - GROUND_HEIGHT - 100 }, size, Icon }); 
                    } 
                }
                 if (pet.skill === 'foresight') {
                    petSkillTimerRef.current.foresight = (petSkillTimerRef.current.foresight || 0) + deltaTime;
                    if (petSkillTimerRef.current.foresight >= petStat) {
                        petSkillTimerRef.current.foresight = 0; let found = 0;
                        gameObjectsRef.current.forEach(obj => { obj.isHighlighted = false; });
                        for (const obj of gameObjectsRef.current) { if (found < 1 && obj.type.startsWith('obstacle') && obj.pos.x > player.pos.x) { obj.isHighlighted = true; found++; } if(found >= 1) break; }
                    }
                }

                const playerRect = { x: player.pos.x, y: player.pos.y, width: player.size.x, height: player.size.y }; const playerCenter = { x: player.pos.x + player.size.x / 2, y: player.pos.y + player.size.y / 2 };
                const remainingGameObjects = [];
                for (const obj of gameObjectsRef.current) {
                    let currentSpeed = actualSpeed;
                    if (player.activeEffects['magnet'] > 0 && (obj.type.includes('jelly') || obj.type === 'energy_core')) { const dist = Math.sqrt(Math.pow(obj.pos.x - playerCenter.x, 2) + Math.pow(obj.pos.y - playerCenter.y, 2)); if (dist < MAGNET_RADIUS) { obj.pos.x -= (obj.pos.x - playerCenter.x) * 0.1; obj.pos.y -= (obj.pos.y - playerCenter.y) * 0.1; } }
                    if (obj.type === 'obstacle_falling') { obj.vy = (obj.vy || 0) + GRAVITY * 0.3 * deltaTime; obj.pos.y += obj.vy * deltaTime; if (obj.pos.y > WORLD_HEIGHT) continue; }
                    
                    if (obj.vx) obj.pos.x += obj.vx * deltaTime; else obj.pos.x -= currentSpeed * deltaTime;
                    if (obj.vy) obj.pos.y += obj.vy * deltaTime;

                    if (obj.lifetime) { obj.lifetime -= deltaTime; if (obj.lifetime <= 0) continue; }
                    if (obj.pos.x < -obj.size.x) { continue; }

                    const objRect = { x: obj.pos.x, y: obj.pos.y, width: obj.size.x, height: obj.size.y };
                    let shouldKeep = true;
                    if (playerRect.x < objRect.x + objRect.width && playerRect.x + playerRect.width > objRect.x && playerRect.y < objRect.y + objRect.height && playerRect.y + playerRect.height > objRect.y) {
                        const handleJellyCollision = (isBig) => { inGameStatsRef.current.jellies++; player.jellyBlastCounter++; if (pet.skill === 'jelly_blast' && player.jellyBlastCounter >= petStat) { player.jellyBlastCounter = 0; createBlast(playerCenter, 150); } const petScoreBonus = (pet.skill === 'score_bonus') ? getPetStat(pet, petData.level, isSynergy) : 0; const treasureScoreBonus = 1 + getTreasureValue('score_bonus'); const jellyScoreBonus = activePartnerBonus?.type === 'jelly_score_bonus' ? 1 + activePartnerBonus.value : 1; const treasureJellyPercentBonus = 1 + getTreasureValue('base_jelly_score_percentage_bonus'); const enhancementBonus = 1 + (playerData.enhancements.jelly_score || 0) * ENHANCEMENTS.jelly_score.baseValue; let baseJellyScore = isBig ? 50 : 10; if (activePartnerBonus?.type === 'base_jelly_score_bonus') baseJellyScore += activePartnerBonus.value; const shadowPactMultiplier = player.isShadowForm ? 2 : 1; let scoreMultiplier = 1; if(character.skill === 'high_speed') { scoreMultiplier = 1.15; } newScore += Math.floor(((baseJellyScore + petScoreBonus) * treasureScoreBonus * jellyScoreBonus * treasureJellyPercentBonus * enhancementBonus * shadowPactMultiplier * (1 + playerLevelBonuses.score)) * scoreMultiplier); if (!gameState.isFeverTime) { const petFeverBonus = (pet.skill === 'fever_boost') ? getPetStat(pet, petData.level, isSynergy) : 0; newFeverGauge = Math.min(FEVER_GAUGE_MAX, newFeverGauge + FEVER_GAUGE_PER_JELLY + petFeverBonus); } shouldKeep = false; };
                        const handleItemCollision = (itemType) => { inGameStatsRef.current.itemsUsed++; let effectMultiplier = (character.skill === 'item_double_effect') ? 2.2 + (charData.level - 1) * 0.06 : 1; let durationMultiplier = 1; if(pet.skill === 'item_duration_boost') durationMultiplier += getPetStat(pet, petData.level, isSynergy); if(activePartnerBonus?.type === 'all_item_duration_bonus') durationMultiplier += activePartnerBonus.value; const finalDurationMultiplier = durationMultiplier * effectMultiplier; if (pet.skill === 'copy_item' && Math.random() < getPetStat(pet, petData.level, isSynergy)) { gameObjectsRef.current.push({ ...obj, id: Math.random(), pos: {x: player.pos.x + 200, y: obj.pos.y} }); } switch(itemType) { case 'health_potion_item': player.health = Math.min(player.maxHealth, player.health + 30 * effectMultiplier); break; case 'giant_potion': player.isGiant = true; player.activeEffects['giant'] = GIANT_POTION_DURATION * (1 + getTreasureValue('giant_duration')) * finalDurationMultiplier; break; case 'blast_jelly': player.isBlasting = true; player.activeEffects['blast'] = BLAST_JELLY_DURATION * finalDurationMultiplier; break; case 'magnet_item': player.hasMagnet = true; let magnetBonus = activePartnerBonus?.type === 'magnet_duration_bonus' ? 1 + activePartnerBonus.value : 1; player.activeEffects['magnet'] = MAGNET_ITEM_DURATION * (1 + getTreasureValue('magnet_duration')) * finalDurationMultiplier * magnetBonus; break; } shouldKeep = false; };
                        
                        if (obj.type === 'rainbow_bear_jelly') { newScore += 15000; newFeverGauge = FEVER_GAUGE_MAX; shouldKeep = false; }
                        else if (obj.type === 'golden_bear_jelly') { inGameStatsRef.current.jellies += 200; shouldKeep = false; }
                        else if (obj.type === 'pink_bear_jelly') { newScore += 25000; shouldKeep = false; }
                        else if (obj.type === 'party_bear_jelly') { newScore += 5000; inGameStatsRef.current.jellies += 50; newFeverGauge = Math.min(FEVER_GAUGE_MAX, newFeverGauge + FEVER_GAUGE_MAX * 0.3); shouldKeep = false; }
                        else if (obj.type.endsWith('_item') || obj.type.endsWith('_potion') || obj.type === 'blast_jelly') { handleItemCollision(obj.type); }
                        else if (obj.type === 'jelly') { handleJellyCollision(false); }
                        else if (obj.type === 'big_jelly') { handleJellyCollision(true); }
                        else if (obj.type.startsWith('obstacle') || obj.type === 'boss_laser' || obj.type === 'boss_projectile') {
                            const isLiftInvincible = player.isSliding && character.skill === 'slide_invincible';
                            const isSlideObstacle = obj.type === 'obstacle_slide';
                            
                            if (isSlideObstacle && player.isSliding) { /* Pass */ } 
                            else if (gameState.isFeverTime || player.isGiant || player.isBlasting || player.isShadowForm || isLiftInvincible) {
                                if(!obj.type.startsWith('boss')) { inGameStatsRef.current.obstaclesDestroyed++; newScore += FEVER_OBSTACLE_SCORE; shouldKeep = false; }
                            } else if (player.shield > 0) {
                                player.shield--;
                                shouldKeep = false;
                            } else if (player.invincibilityTimer > 0) {
                                shouldKeep = false;
                            } else if (pet.skill === 'damage_negation' && Math.random() * 100 < getPetStat(pet, petData.level, isSynergy)) { 
                                shouldKeep = false; 
                            } else { 
                                let damage = OBSTACLE_DAMAGE;
                                if (activePartnerBonus?.type === 'damage_reduction') { damage *= (1 - activePartnerBonus.value); }
                                player.health -= damage; 
                                player.invincibilityTimer = 1.5;
                                setHitFlash(true); 
                                setTimeout(() => setHitFlash(false), 150);
                                shouldKeep = false;
                            }
                        }
                    }
                    if (shouldKeep) {
                        remainingGameObjects.push(obj);
                    }
                }
                gameObjectsRef.current = remainingGameObjects;
                
                inGameStatsRef.current.currentRunScore = newScore;
                let isFeverNow = gameState.isFeverTime; if (!isFeverNow && newFeverGauge >= FEVER_GAUGE_MAX) { isFeverNow = true; inGameStatsRef.current.fevers++; let feverDurBonus = activePartnerBonus?.type === 'fever_duration_bonus' ? 1 + activePartnerBonus.value : 1; const enhancementFeverBonus = (playerData.enhancements.fever_duration || 0) * ENHANCEMENTS.fever_duration.baseValue; newFeverTimeLeft = (FEVER_DURATION + enhancementFeverBonus) * (1 + getTreasureValue('fever_duration')) * feverDurBonus; newFeverGauge = 0; }
                if (newDistance > nextSpawnDistanceRef.current && gameState.status === 'playing') spawnGameObject(); 
                
                setGameState(prev => ({ ...prev, score: Math.floor(newScore), distance: newDistance, gameSpeed: newGameSpeed, isFeverTime: isFeverNow, feverGauge: newFeverGauge, feverTimeLeft: newFeverTimeLeft }));
                forceUpdate({});
            }, [gameState, playerData, selectedCharId, selectedPetId, spawnGameObject, activePartnerBonus, getTreasureValue, finalizeRun, playerLevelBonuses]);

            useGameLoop(gameLoop, (gameState.status === 'playing') && !gameState.isPaused);

            const handleJump = useCallback(() => { if (gameState.status !== 'playing' || gameState.isPaused) return; const player = playerStateRef.current; if (!player || player.jumpCount >= 2 || player.isSliding) return; player.vy = PLAYER_JUMP_FORCE * (1 + getTreasureValue('jump_boost')); player.isJumping = true; player.jumpCount++; inGameStatsRef.current.jumps++; const charData = playerData.characters[selectedCharId] || { level: 1 }; if (CHARACTERS[selectedCharId].skill === 'rhythm_bonus') { player.rhythmJumpCombo++; if(player.rhythmJumpCombo === 5) { setGameState(prev => ({...prev, score: prev.score + (1500 + (charData.level - 1) * 150)})); player.rhythmJumpCombo = 0; } } }, [gameState.status, gameState.isPaused, getTreasureValue, selectedCharId, playerData]);
            const handleJumpRelease = useCallback(() => { if (gameState.status !== 'playing' || gameState.isPaused) return; const player = playerStateRef.current; if (!player || player.vy <= 0) return; player.vy *= 0.5; }, [gameState.status, gameState.isPaused]);
            const handleSlide = useCallback((isSliding) => { if (gameState.status !== 'playing' || gameState.isPaused) return; const player = playerStateRef.current; if (!player || player.isJumping) return; player.isSliding = isSliding; const newSize = isSliding ? PLAYER_SLIDE_SIZE : PLAYER_RUN_SIZE; const oldY = player.pos.y + player.size.y; player.size = newSize; player.pos.y = oldY - newSize.y; const charData = playerData.characters[selectedCharId] || { level: 1 }; if (!isSliding && CHARACTERS[selectedCharId].skill === 'slide_invincible' && Math.random() < charData.level * 0.015) { player.shield = 1; } }, [gameState.status, gameState.isPaused, selectedCharId, playerData]);
            const handleActiveSkill = useCallback(() => {
                if (gameState.status !== 'playing' || gameState.isPaused || gameState.activeSkillCooldown > 0) return;
                const player = playerStateRef.current;
                const charData = playerData.characters[selectedCharId] || { level: 1 };
                const petData = playerData.pets[selectedPetId] || { level: 1 };
                const character = CHARACTERS[selectedCharId];
                const pet = PETS[selectedPetId];
                let cooldown = 0; let skillUsed = false;
                
                if (character.skill === 'laser_beam') {
                    skillUsed = true; cooldown = character.cooldown; const laserSizeY = 30 * (1 + (charData.level - 1) * 0.08); const laserY = player.pos.y + player.size.y / 2 - laserSizeY / 2;
                    gameObjectsRef.current.push({ id: Math.random(), type: 'gazer_laser', pos: { x: player.pos.x + player.size.x, y: laserY }, size: { x: WORLD_WIDTH, y: laserSizeY }, Icon: GazerLaserIcon, lifetime: 0.5 });
                    const affected = gameObjectsRef.current.filter(obj => obj.type.startsWith('obstacle') && obj.pos.y < laserY + laserSizeY && obj.pos.y + obj.size.y > laserY).map(o => o.id);
                    if (affected.length > 0) { inGameStatsRef.current.obstaclesDestroyed += affected.length; gameObjectsRef.current = gameObjectsRef.current.filter(obj => !affected.includes(obj.id)); }
                } else if (pet.skill === 'emp_blast') {
                    skillUsed = true; cooldown = pet.cooldown; createBlast({ x: player.pos.x, y: player.pos.y }, WORLD_WIDTH);
                } else if (character.skill === 'shadow_pact') {
                    const healthCost = player.maxHealth * Math.max(0.08, 0.18 - (charData.level - 1) * 0.005);
                    if (player.health > healthCost + 1) { 
                        skillUsed = true; cooldown = character.cooldown; player.health -= healthCost; let duration = 6; if(activePartnerBonus?.type === 'shadow_pact_duration_bonus') duration += activePartnerBonus.value; player.activeEffects['shadow_pact'] = duration; player.isShadowForm = true;
                    }
                }
                
                if (skillUsed) { let cooldownReduction = activePartnerBonus?.type === 'active_skill_cooldown_reduction' ? 1 - activePartnerBonus.value : 1; setGameState(prev => ({...prev, activeSkillCooldown: cooldown * cooldownReduction})); }
            }, [gameState, selectedCharId, selectedPetId, activePartnerBonus, playerData]);

            useEffect(() => {
                const onKeyDown = (e) => {
                    if (gameState.status !== 'playing' || e.repeat) return;
                    if (e.code === 'Escape') togglePause();
                    if (gameState.isPaused) return;
                    if (e.code === 'KeyF') handleJump();
                    if (e.code === 'KeyJ') handleSlide(true);
                    if (e.code === 'KeyK') handleActiveSkill();
                };
                const onKeyUp = (e) => {
                    if (gameState.status !== 'playing' || gameState.isPaused) return;
                    if (e.code === 'KeyF') handleJumpRelease();
                    if (e.code === 'KeyJ') handleSlide(false);
                };
                window.addEventListener('keydown', onKeyDown);
                window.addEventListener('keyup', onKeyUp);
                return () => {
                    window.removeEventListener('keydown', onKeyDown);
                    window.removeEventListener('keyup', onKeyUp);
                };
            }, [gameState.status, gameState.isPaused, handleJump, handleSlide, handleJumpRelease, togglePause, handleActiveSkill]);

            const costReduction = getTreasureValue('cost_reduction');
            const addXpAndUpdate = (prev, cost, updateFn) => {
                const xpGained = Math.floor(cost / 5);
                const newData = JSON.parse(JSON.stringify(prev));
                newData.currency -= cost;
                updateFn(newData);

                if (newData.level < MAX_PLAYER_LEVEL) {
                    newData.xp += xpGained;
                    let requiredXp = XP_FOR_LEVEL(newData.level);
                    let leveledUp = false;
                    while (newData.xp >= requiredXp && newData.level < MAX_PLAYER_LEVEL) {
                        newData.level++;
                        newData.xp -= requiredXp;
                        leveledUp = true;
                        requiredXp = XP_FOR_LEVEL(newData.level);
                    }
                    if (leveledUp) {
                        setTimeout(() => setLevelUpInfo({ level: newData.level }), 300);
                    }
                }
                return newData;
            }

            const handleLevelUp = (type, id) => {
                setPlayerData(prev => { 
                    if (!prev) return null; 
                    const isChar = type === 'character'; 
                    const data = isChar ? prev.characters[id] : prev.pets[id]; 
                    const cost = LEVEL_UP_COST(data.level, costReduction); 
                    if (prev.currency < cost) return prev; 
                    return addXpAndUpdate(prev, cost, (newData) => {
                        (isChar ? newData.characters[id] : newData.pets[id]).level++;
                    });
                });
            };
            const handleUnlock = (type, id) => {
                setPlayerData(prev => {
                    const isChar = type === 'character';
                    const item = isChar ? CHARACTERS[id] : PETS[id];
                    if (!prev || !item.unlockCost || prev.currency < item.unlockCost || (isChar ? prev.characters[id] : prev.pets[id])) return prev;
                    const newData = JSON.parse(JSON.stringify(prev));
                    newData.currency -= item.unlockCost;
                    if (isChar) { newData.characters[id] = { level: 1 }; } else { newData.pets[id] = { level: 1 }; }
                    return newData;
                });
            };
            const handleClaimMissionReward = (missionId) => {
                 setPlayerData(prev => { const mission = MISSIONS.find(m => m.id === missionId); const missionProgress = prev.missions[missionId]; if(!mission || !missionProgress || !missionProgress.completed || missionProgress.claimed) return prev; const newData = JSON.parse(JSON.stringify(prev)); newData.currency += mission.reward.currency; newData.missions[missionId].claimed = true; return newData; });
            };
             const handleDrawGacha = () => {
                if (!playerData || playerData.currency < GACHA_COST) return;
                setGachaState('animating');
                setTimeout(() => {
                    setPlayerData(prev => {
                        if (!prev || prev.currency < GACHA_COST) { setGachaState('idle'); return prev; }
                        const newData = JSON.parse(JSON.stringify(prev));
                        newData.currency -= GACHA_COST;
                        const luck = getTreasureValue('luck_boost'); const roll = Math.random(); let result = null;
                        const rarityColors = { epic: 'bg-purple-500/30 border-purple-400', rare: 'bg-blue-500/30 border-blue-400', uncommon: 'bg-green-500/30 border-green-400', common: 'bg-gray-500/30 border-gray-400' };
                        if (roll < 0.05 + luck * 0.1) {
                            const target = Object.values(CHARACTERS).find(c => c.skill.includes('laser') || c.skill.includes('shadow_pact'));
                            if (target && !newData.characters[target.id]) { newData.characters[target.id] = { level: 1 }; result = { type: 'character', item: target, rarity: 'epic' }; } 
                            else { const fragmentsGained = 20; const currencyGained = 500; newData.memoryFragments = (newData.memoryFragments || 0) + fragmentsGained; newData.currency += currencyGained; result = { type: 'currency', amount: currencyGained, fragments: fragmentsGained, rarity: 'epic', note: `${target.name} ì¤‘ë³µ` }; }
                        } else if (roll < 0.20 + luck * 0.2) {
                            const target = Object.values(PETS).find(p => p.skill.includes('emp') || p.skill.includes('revive'));
                             if (target && !newData.pets[target.id]) { newData.pets[target.id] = { level: 1 }; result = { type: 'pet', item: target, rarity: 'rare' }; } 
                             else { const fragmentsGained = 10; const currencyGained = 250; newData.memoryFragments = (newData.memoryFragments || 0) + fragmentsGained; newData.currency += currencyGained; result = { type: 'currency', amount: currencyGained, fragments: fragmentsGained, rarity: 'rare', note: `${target.name} ì¤‘ë³µ` }; }
                        } else if (roll < 0.50 + luck * 0.3) {
                            const unowned = Object.values(TREASURES).filter(t => !newData.treasures.includes(t.id));
                            if (unowned.length > 0) { const treasure = unowned[Math.floor(Math.random() * unowned.length)]; newData.treasures.push(treasure.id); result = { type: 'treasure', item: treasure, rarity: 'uncommon' }; } 
                            else { const fragmentsGained = 5; const currencyGained = 500; newData.memoryFragments = (newData.memoryFragments || 0) + fragmentsGained; newData.currency += currencyGained; result = { type: 'currency', amount: currencyGained, fragments: fragmentsGained, rarity: 'uncommon', note: 'ë³´ë¬¼ ì¤‘ë³µ' }; }
                        } else { const amount = 250 + Math.floor(Math.random() * 751); newData.currency += amount; result = { type: 'currency', amount, rarity: 'common' }; }
                        result.rarityColor = rarityColors[result.rarity]; setGachaResult(result); setGachaState('result');
                        return newData;
                    });
                }, 2000);
            };
            const handleToggleEquipTreasure = (treasureId) => {
                setPlayerData(prev => { const newData = JSON.parse(JSON.stringify(prev)); const equipped = new Set(newData.equippedTreasures || []); if(equipped.has(treasureId)) { equipped.delete(treasureId); } else { if(equipped.size < 3) { equipped.add(treasureId); } } newData.equippedTreasures = Array.from(equipped); return newData; });
            };
            const handleUpgradeEnhancement = (id) => {
                setPlayerData(prev => { 
                    const level = prev.enhancements[id] || 0; 
                    const meta = ENHANCEMENTS[id]; 
                    if (level >= meta.maxLevel) return prev; 
                    const cost = ENHANCEMENT_COST(level, costReduction); 
                    if (prev.currency < cost) return prev; 
                    return addXpAndUpdate(prev, cost, (newData) => {
                        newData.enhancements[id]++;
                    });
                });
            };
            const handleTreasureLevelUp = (treasureId) => {
                setPlayerData(prev => {
                    const currentLevel = prev.treasureLevels?.[treasureId] || 0;
                    const cost = TREASURE_LEVEL_UP_COST(currentLevel, costReduction);
                    if (prev.currency < cost) return prev;
                    return addXpAndUpdate(prev, cost, (newData) => {
                        newData.treasureLevels[treasureId] = (newData.treasureLevels[treasureId] || 0) + 1;
                    });
                });
            };
            const handleSaveNickname = () => {
                setPlayerData(prev => ({...prev, nickname: nicknameInput}));
                setCurrentView('main');
            };


            if (!playerData) { return React.createElement('div', { className: "w-screen h-screen flex items-center justify-center text-white glowing-text" }, "Loading..."); }
            
            const renderMenu = () => {
                const character = CHARACTERS[selectedCharId];
                const pet = PETS[selectedPetId];
                const charData = playerData.characters[selectedCharId] || { level: 1 };
                const petData = playerData.pets[selectedPetId] || { level: 1 };
                
                return React.createElement('div', { className: 'w-full h-full flex flex-col text-white' },
                    React.createElement('header', { className: 'w-full p-4 flex justify-between items-center text-lg' },
                        React.createElement('div', { className: 'flex items-center gap-2 bg-black/30 px-3 py-1 rounded-full border border-gray-600' }, 'ðŸ‘¤', playerData.nickname),
                        React.createElement('div', { className: 'flex items-center gap-4' },
                            React.createElement('div', { className: 'flex items-center gap-2 bg-black/30 px-3 py-1 rounded-full border border-gray-600' }, 'ðŸ§ ', playerData.memoryFragments || 0),
                            React.createElement('div', { className: 'flex items-center gap-2 bg-black/30 px-3 py-1 rounded-full border border-gray-600' }, 'J', playerData.currency.toLocaleString())
                        )
                    ),
                    React.createElement('main', { className: 'flex-grow flex flex-col items-center justify-center relative' },
                        React.createElement('div', { className: "absolute top-0 w-3/4 max-w-sm text-center" },
                            React.createElement('div', { className: "flex justify-between items-center text-sm mb-1 px-1" },
                                React.createElement('span', { className: "font-bold text-cyan-300" }, `Lv. ${playerData.level}`),
                                playerData.level < MAX_PLAYER_LEVEL && 
                                    React.createElement('span', { className: "text-gray-400" }, `${playerData.xp.toLocaleString()} / ${XP_FOR_LEVEL(playerData.level).toLocaleString()} XP`)
                            ),
                            React.createElement('div', { className: "progress-bar-container" },
                                React.createElement('div', { 
                                    className: "h-2 progress-bar",
                                    style: { 
                                        width: playerData.level >= MAX_PLAYER_LEVEL ? '100%' : `${(playerData.xp / XP_FOR_LEVEL(playerData.level)) * 100}%`,
                                        background: 'linear-gradient(90deg, #f0f, #9400D3)'
                                    } 
                                })
                            )
                        ),
                        React.createElement('h1', { className: 'absolute top-[calc(2rem+20px)] text-3xl font-black glowing-text' }, "ìžŽì½”ëŒ€ì‰¬"),
                        React.createElement('div', { className: 'w-40 h-40 player-running', onClick: () => setCurrentView('team') }, React.createElement(character.Icon, null)),
                        React.createElement('div', { className: 'w-20 h-20 absolute bottom-[25%] right-[30%] player-running', style:{animationDuration: '0.6s'}, onClick: () => setCurrentView('team') }, React.createElement(pet.Icon, null)),
                         activePartnerBonus && React.createElement('div', { className: "bg-purple-500/20 border border-purple-400 p-2 rounded-lg text-center absolute top-[calc(2rem+60px)]" },
                            React.createElement('p', { className: "font-bold text-sm text-purple-300" }, `âœ¨ ì§ê¿ íš¨ê³¼: ${activePartnerBonus.name} âœ¨`),
                            React.createElement('p', { className: "text-xs text-purple-200" }, activePartnerBonus.description)
                        )
                    ),
                    React.createElement('footer', { className: 'p-4 flex flex-col items-center gap-4' },
                        React.createElement('div', {className: 'text-center'},
                             React.createElement('h2', {className: 'text-xl font-bold'}, `${character.name} Lv.${charData.level}`),
                             React.createElement('h3', {className: 'text-md text-gray-400'}, `${pet.name} Lv.${petData.level}`),
                        ),
                        React.createElement('button', { onClick: () => startGame(), className: "w-full py-4 text-xl font-black ui-button" }, "GAME START"),
                        React.createElement('nav', { className: 'w-full flex justify-around p-2 bg-black/30 rounded-full border border-gray-700' },
                           React.createElement('button', { onClick: () => setCurrentView('team'), className: `nav-button ${currentView === 'team' ? 'active' : ''}` }, 'ðŸ‘¥', React.createElement('span', null, 'íŒ€ íŽ¸ì„±')),
                           React.createElement('button', { onClick: () => setCurrentView('enhancements'), className: `nav-button ${currentView === 'enhancements' ? 'active' : ''}` }, 'ðŸš€', React.createElement('span', null, 'ê°•í™”')),
                           React.createElement('button', { onClick: () => setCurrentView('gacha'), className: `nav-button ${currentView === 'gacha' ? 'active' : ''}` }, 'ðŸŽ', React.createElement('span', null, 'ë½‘ê¸°')),
                           React.createElement('button', { onClick: () => setCurrentView('missions'), className: `nav-button ${currentView === 'missions' ? 'active' : ''}` }, 'ðŸŽ¯', React.createElement('span', null, 'ë¯¸ì…˜')),
                           React.createElement('button', { onClick: () => setCurrentView('treasures'), className: `nav-button ${currentView === 'treasures' ? 'active' : ''}` }, 'ðŸ’Ž', React.createElement('span', null, 'ë³´ë¬¼'))
                        )
                    ),
                    React.createElement('button', { onClick: () => setCurrentView('settings'), className: 'settings-button' }, React.createElement(SettingsIcon, null))
                );
            };

            const renderOverlay = (title, children, onClose) => (
                 React.createElement('div', { className: 'main-overlay overlay-fade-in' },
                    React.createElement('header', { className: 'p-4 flex items-center justify-between border-b border-gray-700' },
                        React.createElement('div', {className: 'w-8'}),
                        React.createElement('h2', { className: 'text-xl font-bold' }, title),
                        React.createElement('button', { onClick: onClose || (() => setCurrentView('main')), className: 'text-2xl font-bold w-8' }, 'Ã—')
                    ),
                    React.createElement('div', { className: 'flex-grow p-4 overflow-y-auto' }, children)
                 )
            );

            const renderTeamSelection = () => {
                 if (teamDetailView) {
                    const {type, id} = teamDetailView;
                    const isChar = type === 'character';
                    const item = isChar ? CHARACTERS[id] : PETS[id];
                    const data = isChar ? playerData.characters[id] : playerData.pets[id];
                    const level = data.level;
                    const cost = LEVEL_UP_COST(level, costReduction);
                    const canAfford = playerData.currency >= cost;

                    return renderOverlay(item.name, 
                        React.createElement('div', {className: 'flex flex-col items-center text-center'}, 
                           React.createElement(item.Icon, {className: 'w-32 h-32'}),
                           React.createElement('p', {className: 'mt-2 text-lg'}, `Lv. ${level}`),
                           React.createElement('p', {className: 'mt-2 text-gray-300'}, item.description),
                           React.createElement('div', {className: 'my-4 w-full bg-gray-700 h-px'}),
                           React.createElement('button', {onClick: () => handleLevelUp(type, id), disabled: !canAfford, className: 'ui-button'}, `ë ˆë²¨ì—… (${cost} J)`)
                        ), () => setTeamDetailView(null));
                 }

                const renderList = (items, type) => (
                    React.createElement('div', { className: 'flex-1 overflow-y-auto' },
                        React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                            Object.values(items).map(item => {
                                const isChar = type === 'character';
                                const data = isChar ? playerData.characters[item.id] : playerData.pets[item.id];
                                const isUnlocked = !!data;
                                const isSelected = isChar ? selectedCharId === item.id : selectedPetId === item.id;
                                
                                return React.createElement('div', { key: item.id, className: `selection-card p-2 text-center flex flex-col justify-between ${isSelected ? 'selected' : ''}` },
                                    isUnlocked ?
                                        React.createElement('div', {className:'flex flex-col items-center'},
                                            React.createElement('div', {onClick: () => isChar ? setSelectedCharId(item.id) : setSelectedPetId(item.id), className: 'w-16 h-16 mx-auto'}, React.createElement(item.Icon, null)),
                                            React.createElement('p', { className: "font-bold mt-1 text-sm" }, item.name),
                                            React.createElement('p', { className: `text-xs` }, `Lv. ${data?.level || 1}`),
                                            React.createElement('button', { onClick: () => setTeamDetailView({type, id: item.id}), className: 'text-xs mt-2 bg-gray-600 px-2 py-1 rounded' }, 'ìƒì„¸ ì •ë³´')
                                        )
                                    :
                                        React.createElement('div', {className:'flex flex-col items-center'},
                                            React.createElement('div', { className: "relative w-16 h-16 mx-auto opacity-70" }, React.createElement(item.Icon, null), React.createElement('div', { className: 'absolute inset-0 bg-black/70 rounded-lg flex items-center justify-center' }, 'ðŸ”’')),
                                            React.createElement('p', { className: "font-bold mt-1 text-sm" }, item.name),
                                            item.unlockCost ? React.createElement('button', { onClick: () => handleUnlock(type, item.id), disabled: playerData.currency < item.unlockCost, className: "w-full mt-2 ui-button text-xs py-1 px-2" }, `${item.unlockCost} J`) 
                                            : React.createElement('p', { className: 'text-xs mt-2' }, 'íšë“ í•„ìš”')
                                        )
                                );
                            })
                        )
                    )
                );
                const selectedCharacter = CHARACTERS[selectedCharId];
                const selectedPet = PETS[selectedPetId];
                 return renderOverlay('íŒ€ íŽ¸ì„±',
                    React.createElement('div', { className: 'flex flex-col h-full' },
                        React.createElement('div', { className: 'flex h-2/3 gap-4' },
                            renderList(CHARACTERS, 'character'),
                            renderList(PETS, 'pet')
                        ),
                        React.createElement('div', { className: 'flex-grow mt-4 p-4 bg-black/30 rounded-lg border border-gray-700 overflow-y-auto' },
                            React.createElement('h3', { className: 'text-lg font-bold text-cyan-300' }, selectedCharacter.name),
                            React.createElement('p', { className: 'text-sm text-gray-300' }, selectedCharacter.description),
                            React.createElement('div', { className: 'my-2 border-t border-gray-600' }),
                            React.createElement('h3', { className: 'text-lg font-bold text-cyan-300' }, selectedPet.name),
                            React.createElement('p', { className: 'text-sm text-gray-300' }, selectedPet.description)
                        )
                    )
                 );
            };

            const renderEnhancements = () => renderOverlay('ì˜êµ¬ ê°•í™”', 
                React.createElement('div', { className: 'flex flex-col gap-4' },
                    Object.keys(ENHANCEMENTS).map(id => {
                        const enhancement = ENHANCEMENTS[id]; const level = playerData.enhancements[id] || 0; const cost = ENHANCEMENT_COST(level, costReduction); const isMaxLevel = level >= enhancement.maxLevel;
                        return React.createElement('div', { key: id, className: "bg-black/30 p-3 rounded-lg border border-gray-700" },
                            React.createElement('div', { className: 'flex justify-between items-start' },
                                React.createElement('div', null,
                                    React.createElement('p', { className: 'font-bold' }, `${enhancement.name} (Lv.${level})`),
                                    React.createElement('p', { className: 'text-sm text-gray-400 mt-1' }, enhancement.description(level))
                                ),
                                React.createElement('button', { onClick: () => handleUpgradeEnhancement(id), disabled: isMaxLevel || playerData.currency < cost, className: "ui-button text-sm flex-shrink-0" }, isMaxLevel ? "MAX" : `${cost} J`)
                            )
                        );
                    })
                )
            );

            const renderMissions = () => renderOverlay('ë¯¸ì…˜', 
                React.createElement('div', { className: 'flex flex-col gap-3' },
                    MISSIONS.map(mission => {
                        const progress = playerData.missions[mission.id] || { progress: 0, completed: false };
                        const isComplete = progress.completed; const canClaim = isComplete && !progress.claimed;
                        return React.createElement('div', { key: mission.id, className: `p-3 rounded-lg border ${canClaim ? 'border-yellow-400' : 'border-gray-700'} bg-black/30` },
                            React.createElement('p', { className: "font-bold" }, mission.description),
                            React.createElement('div', { className: "progress-bar-container mt-2" }, React.createElement('div', { className: "h-2 progress-bar", style: { width: `${Math.min(100, (progress.progress / mission.target) * 100)}%`, background: '#0ff' } })),
                            React.createElement('div', { className: "flex justify-between items-center mt-1" },
                                React.createElement('p', { className: "text-xs text-gray-400" }, `${Math.floor(progress.progress)} / ${mission.target}`),
                                canClaim ? React.createElement('button', { onClick: () => handleClaimMissionReward(mission.id), className: "ui-button text-xs py-1" }, 'ë³´ìƒ ë°›ê¸°') :
                                isComplete ? React.createElement('span', { className: "text-xs text-green-400" }, 'ì™„ë£Œ') : null
                            )
                        );
                    })
                )
            );

            const renderTreasures = () => {
                const getLeveledDescription = (treasure) => {
                    const level = playerData.treasureLevels?.[treasure.id] || 0;
                    if (level === 0) return treasure.description;
                    const multiplier = 1 + level * 0.15;
                    if (treasure.type === 'health_bonus') {
                        return `ìµœëŒ€ ì²´ë ¥ +${Math.floor(treasure.value * multiplier)}`;
                    }
                    return `${treasure.description.split('+')[0]}+${(parseFloat(treasure.description.match(/[\d.]+/)[0]) * multiplier).toFixed(1)}%`;
                };
            
                return renderOverlay('ë³´ë¬¼ ê°•í™”', 
                    React.createElement('div', {className: 'flex flex-col gap-4'},
                        React.createElement('h3', {className: 'font-bold text-lg'}, 'ë³´ìœ  ë³´ë¬¼ (ìµœëŒ€ 3ê°œ ìž¥ì°©)'),
                        playerData.treasures.length === 0 
                            ? React.createElement('p', {className: 'text-center text-gray-400 mt-4'}, 'ë³´ìœ í•œ ë³´ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ë½‘ê¸°ì—ì„œ íšë“í•˜ì„¸ìš”!')
                            : React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                            playerData.treasures.map(id => {
                                const treasure = TREASURES[id];
                                const isEquipped = playerData.equippedTreasures.includes(id);
                                const level = playerData.treasureLevels?.[id] || 0;
                                const cost = TREASURE_LEVEL_UP_COST(level, costReduction);
            
                                return React.createElement('div', { key: id, className: `p-3 rounded-lg border-2 ${isEquipped ? 'border-yellow-400 bg-yellow-500/20' : 'border-gray-600 bg-black/20'}` },
                                    React.createElement('div', { className: 'flex justify-between items-start cursor-pointer', onClick: () => handleToggleEquipTreasure(id) },
                                        React.createElement('div', null,
                                            React.createElement('p', { className: "font-bold" }, `${treasure.name} (Lv.${level})`),
                                            React.createElement('p', { className: "text-xs text-gray-400" }, getLeveledDescription(treasure))
                                        ),
                                        React.createElement('div', {className: 'w-6 h-6 rounded-full border-2 flex items-center justify-center ' + (isEquipped ? 'bg-yellow-400 border-white' : 'border-gray-500')}, isEquipped ? 'âœ“' : '')
                                    ),
                                    React.createElement('div', {className: 'mt-3 flex justify-end items-center'},
                                        React.createElement('button', {
                                            onClick: () => handleTreasureLevelUp(id),
                                            disabled: playerData.currency < cost,
                                            className: 'ui-button text-xs py-1 px-3'
                                        }, `ë ˆë²¨ì—… (${cost} J)`)
                                    )
                                );
                            })
                        )
                    )
                );
            };
            
            const renderGacha = () => renderOverlay('ë¬´í•œ ìƒìž ë½‘ê¸°',
                React.createElement('div', { className: 'flex flex-col items-center justify-center h-full text-center' },
                    gachaState === 'result' && gachaResult ?
                        React.createElement('div', { className: `fade-in flex flex-col items-center p-6 rounded-xl border-2 ${gachaResult.rarityColor}` },
                            React.createElement('p', { className: 'text-2xl font-bold mb-4' }, `íšë“! [${gachaResult.rarity.toUpperCase()}]`),
                            gachaResult.item?.Icon && React.createElement(gachaResult.item.Icon, { className: 'w-32 h-32' }),
                            React.createElement('p', { className: 'text-xl font-bold mt-2' }, gachaResult.item?.name || `+${gachaResult.amount.toLocaleString()} J` + (gachaResult.fragments ? ` & +${gachaResult.fragments} ðŸ§ ` : '')),
                            gachaResult.note && React.createElement('p', {className: 'text-sm text-gray-400'}, `(${gachaResult.note})`),
                            React.createElement('button', { onClick: () => setGachaState('idle'), className: 'ui-button mt-8' }, 'í™•ì¸')
                        )
                    : gachaState === 'animating' ?
                        React.createElement('div', { className: 'flex flex-col items-center justify-center' },
                            React.createElement('p', { className: 'text-9xl', style: { animation: 'box-shake 0.4s ease-in-out 3' } }, 'ðŸŽ'),
                            React.createElement('p', { className: 'text-xl font-bold mt-4 glowing-text' }, 'ê°œë´‰ ì¤‘...')
                        )
                    :
                        React.createElement('div', { className: 'flex flex-col items-center' },
                            React.createElement('p', { className: 'text-9xl' }, 'ðŸŽ'),
                            React.createElement('p', { className: 'text-2xl font-bold mt-4' }, 'ë¬´í•œ ìƒìž'),
                            React.createElement('button', { onClick: handleDrawGacha, disabled: playerData.currency < GACHA_COST, className: "ui-button mt-4" }, `1ê°œ ì—´ê¸° (${GACHA_COST} J)`)
                        )
                ), () => { setGachaState('idle'); setGachaResult(null); setCurrentView('main'); }
            );

            const renderSettings = () => renderOverlay('ì„¤ì •', 
                React.createElement('div', { className: 'flex flex-col gap-8' },
                    React.createElement('div', null,
                        React.createElement('h3', { className: 'text-lg font-bold mb-2' }, 'ë‹‰ë„¤ìž„ ë³€ê²½'),
                        React.createElement('div', { className: 'flex gap-2' },
                            React.createElement('input', { type: 'text', value: nicknameInput, onChange: (e) => setNicknameInput(e.target.value), maxLength: 12, className: 'flex-grow text-input' }),
                            React.createElement('button', { onClick: handleSaveNickname, className: 'ui-button' }, 'ì €ìž¥')
                        )
                    ),
                    React.createElement('div', null,
                        React.createElement('h3', { className: 'text-lg font-bold mb-2' }, 'ê²Œìž„ ë°ì´í„°'),
                         React.createElement('button', { onClick: () => { if(window.confirm('ì •ë§ë¡œ ê²Œìž„ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) { Cookies.remove('ipkoDashDataV4_player_level'); window.location.reload(); } }, className: 'ui-button danger' }, 'ë°ì´í„° ì´ˆê¸°í™”')
                    )
                )
            );

            const renderLevelUpModal = () => {
                const bonuses = {
                    health: levelUpInfo.level * 2,
                    score: (levelUpInfo.level * 0.1).toFixed(1),
                    currency: (levelUpInfo.level * 0.1).toFixed(1)
                };
                return React.createElement('div', { className: "main-overlay overlay-fade-in items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-slate-800/80 border-2 border-yellow-400 rounded-2xl p-8 text-center shadow-lg shadow-yellow-500/20 fade-in w-full max-w-md" },
                        React.createElement('h2', { className: "text-5xl font-black text-yellow-300 glowing-text" }, "LEVEL UP!"),
                        React.createElement('p', { className: "mt-4 text-3xl font-bold" }, `Lv. ${levelUpInfo.level}`),
                        React.createElement('div', { className: 'my-4 w-full bg-gray-700 h-px' }),
                        React.createElement('h3', { className: 'text-lg font-bold mb-2' }, 'ë ˆë²¨ ë³´ë„ˆìŠ¤'),
                        React.createElement('ul', { className: 'text-left list-disc list-inside mx-auto w-fit' },
                            React.createElement('li', null, `ìµœëŒ€ ì²´ë ¥: +${bonuses.health}`),
                            React.createElement('li', null, `ëª¨ë“  ì ìˆ˜ íšë“: +${bonuses.score}%`),
                            React.createElement('li', null, `ì ¤ë¦¬ íšë“ëŸ‰: +${bonuses.currency}%`)
                        ),
                        React.createElement('button', { onClick: () => setLevelUpInfo(null), className: "mt-8 px-8 py-3 ui-button" }, "í™•ì¸")
                    )
                );
            };

            const renderGame = () => {
                const player = playerStateRef.current; if (!player) return null;
                const CurrentCharacterIcon = CHARACTERS[selectedCharId].Icon;
                let playerClass = 'player-running'; 
                if(player.isGiant) playerClass = 'player-giant'; 
                else if (player.isJumping) playerClass = player.vy > 0 ? 'player-jumping' : 'player-falling';
                if(player.isShadowForm) playerClass += ' shadow-form-effect';
                if (player.invincibilityTimer > 0) playerClass += ' player-invincible';
                
                let playerTransform = ''; if(player.isBlasting) playerTransform = `translateX(${Math.random()*10 - 5}px)`;
                const character = CHARACTERS[selectedCharId];
                const pet = PETS[selectedPetId];
                const hasActiveSkill = character.skill === 'laser_beam' || pet.skill === 'emp_blast' || character.skill === 'shadow_pact';

                return React.createElement('div', { className: "relative w-full h-full overflow-hidden" },
                    React.createElement('div', { style: { position: 'absolute', inset: 0, backgroundImage: 'url(background.png)', backgroundRepeat: 'repeat-x', backgroundSize: `auto ${WORLD_HEIGHT}px`, backgroundPosition: `${backgroundXRef.current}px 0` } }),
                    hitFlash && React.createElement('div', { className: "hit-flash-overlay" }),
                    gameState.isFeverTime && React.createElement('div', { className: "fever-active-overlay" }),
                    React.createElement('div', { className: "absolute top-0 left-0", style: { width: WORLD_WIDTH, height: WORLD_HEIGHT } },
                        React.createElement('div', { className: `absolute ${playerClass}`, style: { left: player.pos.x, top: player.pos.y, width: player.size.x, height: player.size.y, transform: playerTransform, transition: 'width 0.1s, height 0.1s' } },
                           React.createElement(CurrentCharacterIcon, null),
                           player.shield > 0 && React.createElement('div', {className: 'shield-effect'})
                        ),
                        gameObjectsRef.current.map(obj => React.createElement('div', { key: obj.id, className: `absolute ${obj.isHighlighted ? 'obstacle-highlight' : ''}`, style: { left: obj.pos.x, top: obj.pos.y, width: obj.size.x, height: obj.size.y } }, React.createElement(obj.Icon, null))),
                        React.createElement('div', { className: "absolute bottom-0 left-0 w-full bg-cyan-800", style: { height: GROUND_HEIGHT, boxShadow: '0 -10px 20px rgba(0, 255, 255, 0.5)' } })
                    ),
                    React.createElement('div', { className: "absolute top-2 left-4 right-4 text-white font-bold flex flex-col gap-2" },
                         React.createElement('div', { className: "flex items-center gap-4"},
                            React.createElement('div', { className: 'text-2xl' }, `SCORE: ${gameState.score}`),
                            React.createElement('div', { className: 'flex-grow flex flex-col gap-1' },
                                React.createElement('div', { className: "progress-bar-container" }, React.createElement('div', { className: "h-3 progress-bar health-bar", style: { width: `${(player.health / player.maxHealth) * 100}%` } }))
                            ),
                            React.createElement('button', {onClick: togglePause, className: "w-10 h-10 p-1 flex-shrink-0"}, 
                              React.createElement('svg', { viewBox: "0 0 100 100", fill: "white" }, 
                                React.createElement('rect', { x: "25", y: "15", width: "15", height: "70", rx:"5" }),
                                React.createElement('rect', { x: "60", y: "15", width: "15", height: "70", rx:"5" })
                              )
                            )
                        )
                    ),
                    React.createElement('div', { className: 'jump-indicator-container' },
                       React.createElement('div', { className: `jump-indicator ${player.jumpCount >= 1 ? 'used' : ''}`}),
                       React.createElement('div', { className: `jump-indicator ${player.jumpCount >= 2 ? 'used' : ''}`})
                    ),
                    React.createElement('div', { className: `control-button left-4`, onMouseDown: handleJump, onMouseUp: handleJumpRelease, onTouchStart: (e) => { e.preventDefault(); handleJump(); }, onTouchEnd: (e) => { e.preventDefault(); handleJumpRelease(); } }, React.createElement('span', { className: "text-5xl text-white/80" }, "â†‘")),
                    React.createElement('div', { className: `control-button right-4 ${player.isJumping ? 'opacity-50' : ''}`, onMouseDown: () => handleSlide(true), onMouseUp: () => handleSlide(false), onTouchStart: (e) => { e.preventDefault(); handleSlide(true); }, onTouchEnd: (e) => { e.preventDefault(); handleSlide(false); } }, React.createElement('span', { className: "text-5xl text-white/80" }, "â†“")),
                    hasActiveSkill && React.createElement('button', { className: `control-button skill-button ${gameState.activeSkillCooldown <= 0 ? 'ready' : ''}`, onClick: handleActiveSkill, disabled: gameState.activeSkillCooldown > 0}, 
                        React.createElement('span', { className: "text-4xl text-white/80" }, "âš¡ï¸"),
                        gameState.activeSkillCooldown > 0 && React.createElement('div', {className: 'cooldown-overlay'}, Math.ceil(gameState.activeSkillCooldown))
                    )
                );
            };

            const renderGameOver = () => React.createElement('div', { className: "main-overlay overlay-fade-in items-center justify-center p-4" },
                React.createElement('div', { className: "bg-slate-800/80 border-2 border-cyan-400 rounded-2xl p-8 text-center shadow-lg shadow-cyan-500/20 fade-in w-full max-w-md" },
                    React.createElement('h2', { className: "text-5xl font-black text-red-500 glowing-text" }, "GAME OVER"),
                    React.createElement('p', { className: "mt-4 text-2xl" }, "Final Score: ", React.createElement('span', { className: "text-cyan-300 font-bold" }, gameState.score.toLocaleString())),
                    React.createElement('p', { className: "mt-2 text-xl" }, "High Score: ", React.createElement('span', { className: "text-yellow-300 font-bold" }, playerData.highScore.toLocaleString())),
                    React.createElement('p', { className: "mt-2 text-xl" }, "Earned Jellies: ", React.createElement('span', { className: "text-yellow-300 font-bold" }, `+${Math.floor(inGameStatsRef.current.jellies * 5).toLocaleString()}`)),
                    React.createElement('button', { onClick: () => { setGameState(prev => ({ ...prev, status: 'menu' })); setCurrentView('main'); }, className: "mt-8 px-8 py-3 ui-button" }, "ë©”ì¸ ë©”ë‰´")
                )
            );

            const renderPauseMenu = () => React.createElement('div', { className: "main-overlay overlay-fade-in items-center justify-center p-4" },
                React.createElement('div', { className: "bg-slate-800/80 border-2 border-cyan-400 rounded-2xl p-8 text-center shadow-lg shadow-cyan-500/20 fade-in flex flex-col gap-4 w-full max-w-md" },
                    React.createElement('h2', { className: "text-5xl font-black text-white glowing-text" }, "PAUSED"),
                    React.createElement('button', { onClick: togglePause, className: "px-8 py-3 ui-button" }, "ê²Œìž„ ìž¬ê°œ"),
                    React.createElement('button', { onClick: () => { finalizeRun(); setGameState({ status: 'menu', isPaused: false }); setCurrentView('main'); }, className: "px-8 py-3 ui-button" }, "ë©”ì¸ ë©”ë‰´")
                )
            );
            
            const currentOverlay = () => {
              switch(currentView) {
                case 'team': return renderTeamSelection();
                case 'enhancements': return renderEnhancements();
                case 'missions': return renderMissions();
                case 'treasures': return renderTreasures();
                case 'gacha': return renderGacha();
                case 'settings': return renderSettings();
                default: return null;
              }
            };

            return React.createElement('div', { className: "relative w-screen h-screen bg-black text-white flex items-center justify-center overflow-hidden font-sans antialiased select-none" },
                 React.createElement('div', { className: "relative overflow-hidden bg-black", style: { width: WORLD_WIDTH, height: WORLD_HEIGHT, transform: `scale(${scale})`, transformOrigin: 'center center' } },
                    gameState.status === 'menu' && renderMenu(),
                    (gameState.status === 'playing' || gameState.status === 'gameOver') && renderGame(),
                    gameState.status === 'gameOver' && renderGameOver(),
                    gameState.isPaused && renderPauseMenu(),
                    currentView !== 'main' && gameState.status === 'menu' && currentOverlay(),
                    levelUpInfo && renderLevelUpModal()
                )
            );
        };

        // --- END OF MERGED App.tsx ---

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(React.StrictMode, null, React.createElement(App, null)));
    </script>
  </body>
</html>